**Replacement Cost Playbook**

- 目的: 個人開発プロダクト「序の紋章 III（オンライン版）」の置き換えコストを第三者に明確化し、価値の根拠として提示する。再制作の難所・SLO・運用Runbook・移管チェックを1枚で俯瞰できるようにする。

**要約（Executive Summary）**
- 置き換えコスト目安: 25–35人月（日本国内小〜中規模の人月単価を用いると概算 3,000–5,000 万円）
- 根拠: リアルタイム同期（Firestore+RTDB）/ サーバー権威 / XState(FSM) / Pixi+GSAP / PWA安全更新（SW）/ 可観測性（メトリクス・トレース）/ E2E の総合難度
- リスク削減要素: 失敗時シナリオの網羅・運用Runbook・SLO基準・依存ライセンスの整理

**スコープマップ（同等品質で再制作する場合の必須範囲）**
- リアルタイム同期
  - Firestore（ゲーム状態）+ RTDB（Presence）を併用、観戦→再入室、host-claim、waiting reset のサーバー権威化
- クライアント制御
  - XStateベースの状態機械、UI分岐、StrictMode非依存の描画安定
- レンダリング/演出
  - Pixi.js 8 + GSAP 3、カードの3D的回転・showtime演出、reduced-motion対応、メモリ/リーク対策
- PWA安全更新
  - Service Worker の待機検知・自動/手動適用・タブ間連携（BroadcastChannel）・ループガード
- 可観測性/品質
  - メトリクス（perf/audio/drop 等）・トレースバッファ・Jest/Playwright系E2E
- 決済/認証（任意）
  - Stripe・Firebase Auth 連携、鍵/環境の運用設計

**SLO（Service Level Objectives）と計測手段**
- 推奨SLO（p95基準の一例）
  - client.drop.queueWaitMs < 16ms（カードD&Dのキュー待機）
  - audio.pointerToSoundMs < 80ms（入力→最初の効果音）
  - SW待機→適用完了 ≤ 5s（自動適用時）
  - ルーム状態反映 commit ≤ 50ms（UI反映までのコミット）
- 計測手段
  - ブラウザコンソールで dumpItoMetrics() を実行（メトリクスとトレースのスナップショット出力）
  - メトリクス格納: window.__ITO_METRICS__、トレース: window.__ITO_TRACE_BUFFER__
  - 主要キー例: perf.* / audio.* / client.drop.* / sw.* / safeUpdate.*

**失敗時シナリオと緩和策（抜粋）**
- Service Worker / 安全更新
  - timeout: 適用タイムアウト時は失敗状態へ遷移し、一定条件で再試行。手動適用UIを提示
  - redundant: 競合発生時は失敗として扱い、再同期→再適用
  - no_waiting: 待機なし時は適用不可を明示（ハードリロード誘導）
  - suppressed（ループガード）: 自動適用を停止し、明示的な手動ボタンに切替
- リアルタイム/Presence
  - 回線断→復帰: Presenceで可視化、観戦→メンバー復帰のセーフガード
  - host-claim 競合: サーバーAPI権威で決定、クライアントは追従
  - waiting reset: 正規API経由（クライアント直接書込み禁止）

**テストとエビデンス（例）**
- テスト観点
  - 状態遷移（FSM）: フェーズ遷移・ブロック条件・観戦復帰
  - SW更新: 待機→可視/非可視/アイドル適用、失敗系（timeout/redundant/no_waiting/suppressed）
  - D&Dインタラクション: queueWaitMs の分布と体感追従
  - 回線断/復帰: プレゼンス・再購読・データ一貫性
- 推奨E2E（Playwright）
  - ルーム作成→参加→進行→終了→再開の一連と、途中の回線断/復帰・SW適用挿入

**リリース/ロールバック/安全更新 Runbook**
- バージョンタグ付与: sw.js?v=<app_version> で確定
- 適用トリガー
  - 可視状態: 手動ボタン優先（ゲーム進行中は保留）
  - 非可視/アイドル: 自動適用（ループガード有）
- タブ間連携: BroadcastChannel で待機/適用/失敗/保留を通知
- 失敗時
  - 自動→失敗で手動誘導、再同期→再試行。ループガード作動時は自動停止
- ロールバック
  - 直前バージョンを保持、必要なら再デプロイ。クライアント側はルーム待機状態で自動適用

**移管チェックリスト（買い手向け）**
- ソース/ビルド/CI
  - ソース一式、環境別設定、CI/CD（ビルド・デプロイ手順）
- 秘密情報
  - Firebase（Firestore/RTDB/Auth/Functions）、Stripe、Sentry 等の鍵と権限移譲
- 運用Runbook
  - リリース/ロールバック、SW安全更新、障害時の復旧手順
- 可観測性
  - メトリクス送出、ダッシュボード、dumpItoMetrics の使い方
- アセット/ライセンス
  - 画像/音源/フォントの出所と利用許諾、主要依存（Pixi/GSAP等）のライセンス適合
- ドメイン/ブランド
  - ドメイン、アプリ名称/ロゴの扱い（譲渡かライセンスか）

**依存ライセンスとアセット権利（サマリ）**
- 主要依存（例）
  - Pixi.js 8（ライセンス: MIT）
  - GSAP 3（商用利用条件を要確認）
  - Firebase SDK、Next.js、Chakra UI ほか
- アセット
  - 画像/音声/SFX/BGMの出所、権利範囲、再配布可否を台帳化して同梱

**置き換えコストの簡易式**
- 人員 × 月数 × 人月単価 ＋（デザイン/QA/予備 20%）
- 例: 5 人 × 6 ヶ月 × 130 万円 ≒ 3,900 万円（＋デザイン/QAで 4,300–4,700 万円）

**価格帯の目安（参考）**
- 非独占ライセンス（用途/期間制限、ソース非開示可）: 800–1,500 万円
- 限定独占（領域/地域/年限2–3年）: 1,200–2,500 万円
- 完全権利譲渡（引継ぎ1–2ヶ月含む）: 4,000–6,000 万円

**提示時のポイント**
- UIの再現では到達できない非機能（安全更新・回線断復帰・計測）を、SLOと失敗時対策で定量提示
- Runbook/チェックリストを添付し、移管リスク（= 値引き要因）を事前に潰す
- 置き換えコストと価格の違いを明記（買収は一般に置き換えコスト以上）

**体験価値（オリジナリティ）と“置き換え困難性”**
- 相談タイムの再発明
  - 失敗後の「惰性の答え合わせ」を、ドラッグ編集可能な並べ替えボードに置換。
  - 参加者が自分の世界観・価値観を語れる“会話の起点”をUIで作る＝コミュニケーションが最も盛り上がる瞬間を増幅。
- Showtime演出（Pixi.js + GSAP）
  - 全参加者カードの3D回転や演出の“見せ場”を背景テーマと連動させ、BGM/SFXと同期して多幸感を演出。
  - テーマを切り替えるだけでショーが変わる拡張性（後述の課金パック化に直結）。
- 観戦体験の拡張
  - 観戦チケットや観戦入室を用意し、「一人でも楽しい」視聴モードを提供。コミュニティの学習曲線を下げ、間接的に参加率を押し上げる。
- ロビー常時可視×メインメニュー一体化×掲示板
  - “見た目のかっこよさ”より「今ここで人が遊んでいる安心感」を優先。入室直後から熱量が視覚化されるため、その場に留まりたくなる。
  - Discord連携で募集・合流を高速化し、外部コミュニティからの流入も獲得。
- マネタイズ拡張（例）
  - Showtimeパック（背景/カード絵/効果音/BGM）、季節イベントスキン、観戦パス、ロビー特別枠 など。
- 置き換えコストへの影響
  - 上記を“基盤から”同等品質で再制作する場合、基準の 3,000–5,000 万円に対し +15〜30% の上振れ要因。

**定着率（Retention）設計とSLO**
- 体験仮説
  - “いつ行っても誰かいる”感をUIで即座に伝達できると、DAUとセッション長が伸びる。
  - 相談タイムを「操作×会話」で増幅し、勝敗に関係なく満足度を維持できると、継続率が上がる。
- 推奨SLO（p95 目標値の一例）
  - ロビー熱量表示の初期応答（入室→「誰が遊んでいるか」が分かるまで）≤ 750ms
  - “今プレイ中”インジケータの更新レイテンシ ≤ 400ms
  - 観戦入室→盤面可視化 ≤ 1.5s
  - 相談タイムのドラッグ反映 commit ≤ 50ms（UI追従）
- 計測キーの例（dumpItoMetrics 用）
  - lobby.timeToHeat, lobby.nowPlayingUpdateMs, spectator.joinToVisibleMs, client.drop.queueWaitMs
  - 併せて DAU / セッション長 / ロビー閲覧→入室CV, Discord→入室CV を継続トラッキング。

**付録: 失敗時シナリオテンプレ（追記用）**
- SW: timeout / redundant / no_waiting / suppressed の再現手順・ユーザー提示文言・自動再試行条件
- 回線断/復帰: 断の検知、購読の再開、観戦→合流の条件、UI提示
- host-claim: 申請/確定/保留の分岐、権威APIの戻り待ちとUI

以上。対外提示はこのMDの冒頭サマリ＋SLO/Runbook/チェックリストの章を中心に抜粋し、必要に応じてPDF化してください。
