# Firestore インデックス棚卸しプレイブック

最終更新: 2025-09-29 (Asia/Tokyo)

Firestore の複合インデックス / 単一フィールド除外を定期的に見直し、クエリ性能とコストを最適化するための運用手順をまとめました。

---

## 1. 棚卸しを行うタイミング

| タイミング                              | 理由                                                           |
| --------------------------------------- | -------------------------------------------------------------- |
| 大規模リリースの前後                    | 新しいクエリやスキーマ変更で "Missing index" が出るのを防ぐ    |
| 月次〜四半期の定期点検                  | 不要インデックスを削除し、ストレージ / 書き込みコストを抑制    |
| Firestore 請求額が跳ね上がったとき      | 巨大フィールドの自動インデックスが原因のケースが多い           |
| TTL 対象フィールドを新設 / 更新したとき | TTL フィールドは単一フィールドインデックス除外が推奨されるため |

> 参考: [Cloud Firestore インデックスの種類（公式）](https://firebase.google.com/docs/firestore/query-data/index-overview)

---

## 2. 棚卸しチェックリスト

1. **必要な複合インデックスが揃っているか**
   - `firestore.indexes.suggested.json` やエラーログに "Missing index" が残っていないか確認。
2. **不要な複合インデックスを削除できるか**
   - 使われていない（もしくは古いクエリでしか使われない）定義は削除し、書き込みコストを削減。
3. **単一フィールドインデックス除外の最適化**
   - TTL フィールド (`expiresAt` など)、巨大文字列、クエリ対象外の配列 / Map を `fieldOverrides` で除外。
4. **クエリ使用状況と差分がないか**
   - 直近 1〜3 ヶ月で新しいクエリが追加されていないか、監視やダッシュボードの内容と突き合わせる。

---

## 3. 具体的な進め方

1. **現状把握**
   - `firebase firestore:indexes:list` でクラスタに登録済みの定義を取得。
   - ローカルの `firestore.indexes.json` / `firestore.indexes.suggested.json` と差分を確認。
2. **要不要判定**
   - 次の 1〜3 ヶ月で利用するクエリを洗い出し、必要な複合インデックスのみ残す。
   - TTL フィールドなどは単一フィールド除外へ追加（例: `stripe_events.expiresAt`）。
3. **検証**
   - `firebase deploy --only firestore:indexes` をステージング環境で実行し、アプリ全体の主要クエリを QA。
   - 問題なければ本番へ反映。
4. **記録と次回予定**
   - Slack / Notion などで変更点を共有し、次回棚卸しの予定（例: 来月初週）をカレンダーへ登録。

---

## 4. 運用ヒント

- **Missing index に備えて**  
  デバッグ環境で意図的にクエリを走らせ、「インデックスが必要です」のリンクから直接 `firestore.indexes.json` を更新すると安全。
- **除外設定の追加**  
  `fieldOverrides` に設定したフィールドは自動インデックスから除外されるため、クエリから利用する場合は複合インデックスに明示的に追加する。
- **ドキュメント数が多いコレクション**  
  連番タイムスタンプを並べるようなフィールドに複合インデックスを作るとホットスポットになりやすい。必要性を再確認する。

---

## 5. 次回の棚卸しテンプレ

- 実施日:
- 担当者:
- 変更内容:
  - 追加した複合インデックス:
  - 削除した複合インデックス:
  - 単一フィールド除外を追加 / 更新したフィールド:
- QA 結果:
- 次回の棚卸し予定日:

---

このファイルをベースに、棚卸し完了後の記録や振り返りを更新していってください。
