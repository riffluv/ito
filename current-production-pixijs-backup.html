<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>åºã®ç´‹ç« III - ç¾åœ¨ã®æœ¬ç•ªç’°å¢ƒPixiJSèƒŒæ™¯ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  html,body{margin:0;height:100%;background:#0E0F13;overflow:hidden}
  canvas{display:block}
  .note{position:fixed;left:10px;bottom:10px;color:#fff;background:rgba(0,0,0,.35);
        padding:6px 8px;border-radius:8px;font:12px/1.2 system-ui}
</style>
</head>
<body>
<div class="note">åºã®ç´‹ç« III - ç¾åœ¨ã®æœ¬ç•ªç’°å¢ƒPixiJSèƒŒæ™¯ï¼ˆå®Œå…¨ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰</div>

<script src="https://pixijs.download/release/pixi.min.js"></script>
<script>
// === åºã®ç´‹ç« III - ç¾åœ¨ã®æœ¬ç•ªç’°å¢ƒPixiJSèƒŒæ™¯ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— ===
// ThreeBackground.tsx ã® pixijséƒ¨åˆ†ã®å®Œå…¨ç§»æ¤
async function initProductionPixiBackground() {
  // ãƒ‡ãƒã‚¤ã‚¹æ€§èƒ½åˆ¤å®šï¼ˆæœ¬ç•ªç’°å¢ƒã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
  const isLowPowerDevice = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

  console.log('ğŸ® æœ¬ç•ªç’°å¢ƒPixiJSèƒŒæ™¯ èµ·å‹•é–‹å§‹...');

  let app = null;
  let frameId;
  let isAnimating = false;

  try {
    // PixiJS v8å¯¾å¿œ: æ­£ã—ã„init()æ–¹æ³•
    app = new PIXI.Application();
    await app.init({
      width: window.innerWidth,
      height: window.innerHeight,
      backgroundColor: 0x0E0F13, // ãƒ†ãƒ¼ãƒçµ±ä¸€ï¼ˆ16é€²æ•°ã§æŒ‡å®šï¼‰
      antialias: !isLowPowerDevice,
      resolution: isLowPowerDevice ? 1 : Math.min(1.3, window.devicePixelRatio || 1),
      autoDensity: false,
    });

    document.body.appendChild(app.canvas);
    console.log('ğŸ“± ã‚­ãƒ£ãƒ³ãƒã‚¹è¿½åŠ å®Œäº†');

    // === ãƒ‰ãƒ©ã‚¯ã‚¨é¢¨ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼èƒŒæ™¯ ===

    // 1. çµ±ä¸€ã•ã‚ŒãŸå¤œç©ºèƒŒæ™¯ï¼ˆæœˆãŒã‚ã‚‹ã¨ã“ã‚ã¨åŒã˜è‰²ã§å…¨ç”»é¢çµ±ä¸€ï¼‰
    const bgGradient = new PIXI.Graphics();
    bgGradient.rect(0, 0, app.screen.width, app.screen.height);
    bgGradient.fill({
      color: 0x1a1a2e, // ãƒ‰ãƒ©ã‚¯ã‚¨é¢¨æ¿ƒç´ºï¼ˆå…¨ç”»é¢çµ±ä¸€ï¼‰
      alpha: 1,
    });
    app.stage.addChild(bgGradient);

    // ä¸Šéƒ¨ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœã‚‚å…¨ç”»é¢ã«é©ç”¨
    const bgGradient2 = new PIXI.Graphics();
    bgGradient2.rect(0, 0, app.screen.width, app.screen.height); // å…¨ç”»é¢ã«å¤‰æ›´
    bgGradient2.fill({
      color: 0x16213e, // å°‘ã—æ˜ã‚‹ã„æ·±ç´«ï¼ˆå…¨ç”»é¢çµ±ä¸€ï¼‰
      alpha: 0.7,
    });
    app.stage.addChild(bgGradient2);

    // 2. å±±å²³åœ°å¸¯ã®ã‚·ãƒ«ã‚¨ãƒƒãƒˆï¼ˆèŒ¶è‰²ã®è¬ã®ç‰©ä½“=åŸã‚’å‰Šé™¤ã€å±±ã®ã¿æ®‹ã™ï¼‰
    const mountains = new PIXI.Graphics();

    // å±±å²³åœ°å¸¯ã®ã¿ï¼ˆåŸã¯å‰Šé™¤ï¼‰
    mountains.moveTo(0, app.screen.height * 0.8);
    for (let i = 0; i <= app.screen.width; i += 80) {
      const height = app.screen.height * (0.75 + Math.sin(i * 0.008) * 0.1 + Math.random() * 0.05);
      mountains.lineTo(i, height);
    }
    mountains.lineTo(app.screen.width, app.screen.height);
    mountains.lineTo(0, app.screen.height);

    mountains.fill({
      color: 0x2c1810, // å±±ã®ã‚·ãƒ«ã‚¨ãƒƒãƒˆè‰²ï¼ˆæ¿ƒã„ãƒ–ãƒ©ã‚¦ãƒ³ï¼‰
      alpha: 0.8,
    });
    app.stage.addChild(mountains);

    // 3. æµ®éŠã™ã‚‹å…‰ã®ç²’å­ï¼ˆãƒ‰ãƒ©ã‚¯ã‚¨é¢¨ãƒã‚¸ãƒƒã‚¯ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ï¼‰
    // ãƒ‰ãƒ©ã‚¯ã‚¨é¢¨ç¥ç§˜çš„ãªé’ç™½ãƒ»ç´«ç³»é­”æ³•è‰²å½©
    const magicColors = [
      0x87ceeb, // ã‚¹ã‚«ã‚¤ãƒ–ãƒ«ãƒ¼
      0x9370db, // ãƒŸãƒ‡ã‚£ã‚¢ãƒ ãƒ‘ãƒ¼ãƒ—ãƒ«
      0x6495ed, // ã‚³ãƒ¼ãƒ³ãƒ•ãƒ©ãƒ¯ãƒ¼ãƒ–ãƒ«ãƒ¼
      0xb19cd9, // ãƒ©ã‚¤ãƒˆãƒ‘ãƒ¼ãƒ—ãƒ«
      0x5f9ea0, // ã‚«ãƒ‡ãƒƒãƒˆãƒ–ãƒ«ãƒ¼
      0x9966cc, // ã‚¢ãƒ¡ã‚¸ã‚¹ãƒˆ
      0x66cdaa, // ãƒŸãƒ‡ã‚£ã‚¢ãƒ ã‚¢ã‚¯ã‚¢ãƒãƒªãƒ³
      0x7b68ee, // ãƒŸãƒ‡ã‚£ã‚¢ãƒ ã‚¹ãƒ¬ãƒ¼ãƒˆãƒ–ãƒ«ãƒ¼
    ];

    const particles = [];
    for (let i = 0; i < 30; i++) {
      const particle = new PIXI.Graphics();
      particle.circle(0, 0, Math.random() * 2 + 1);
      particle.fill({
        color: magicColors[Math.floor(Math.random() * magicColors.length)], // ãƒ‰ãƒ©ã‚¯ã‚¨é­”æ³•è‰²ã‹ã‚‰é¸æŠ
        alpha: Math.random() * 0.6 + 0.4, // ç¥ç§˜çš„ãªå…‰åº¦
      });

      particle.x = Math.random() * app.screen.width;
      particle.y = Math.random() * app.screen.height;

      const particleData = {
        particle,
        vx: (Math.random() - 0.5) * 0.5,
        vy: (Math.random() - 0.5) * 0.3,
        life: Math.random() * 2 + 1,
      };

      particles.push(particleData);
      app.stage.addChild(particle);
    }

    // 4. ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼å²©å ´ãƒ»ä¸˜é™µåœ°å½¢ï¼ˆå³ä¸‹ã¾ã§ç¢ºå®Ÿã«åŸ‹ã‚ã‚‹ï¼‰
    const foreground = new PIXI.Graphics();
    const terrainY = app.screen.height * 0.87;

    // ãƒ‰ãƒ©ã‚¯ã‚¨é¢¨ã®é™ºã—ã„å²©å ´åœ°å½¢ï¼ˆå³ä¸‹ã¾ã§ç¢ºå®Ÿã«åŸ‹ã‚ã‚‹ï¼‰
    foreground.moveTo(0, terrainY);
    for (let i = 0; i <= app.screen.width + 10; i += 25) { // +10ã§ç¢ºå®Ÿã«å³ç«¯ã¾ã§
      const rockiness = Math.sin(i * 0.012) * 18 + Math.cos(i * 0.025) * 8 + terrainY;
      foreground.lineTo(i, rockiness);
    }
    // ç¢ºå®Ÿã«å³ä¸‹è§’ã¾ã§åŸ‹ã‚ã‚‹
    foreground.lineTo(app.screen.width + 10, app.screen.height + 10);
    foreground.lineTo(-10, app.screen.height + 10);
    foreground.fill({
      color: 0x2f2f2f, // ãƒ€ãƒ¼ã‚¯ã‚°ãƒ¬ã‚¤ï¼ˆãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼å²©å ´ï¼‰
      alpha: 0.88,
    });
    app.stage.addChild(foreground);

    // 5. å³ä¸Šã®ç¥ç§˜çš„ãªãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼æœˆ
    const createFantasyMoon = () => {
      const moonContainer = new PIXI.Container();

      // æœˆæœ¬ä½“ï¼ˆãƒ‰ãƒ©ã‚¯ã‚¨é¢¨ã®é’ç™½ã„ç¥ç§˜çš„ãªè‰²ï¼‰
      const moon = new PIXI.Graphics();
      moon.circle(0, 0, 45);
      moon.fill({
        color: 0xe6f3ff, // ç¥ç§˜çš„ãªé’ç™½è‰²
        alpha: 0.92,
      });

      // æœˆã®å…‰è¼ªï¼ˆé’ç´«ã®ç¥ç§˜çš„ãªå…‰ï¼‰
      const glow = new PIXI.Graphics();
      glow.circle(0, 0, 85);
      glow.fill({
        color: 0x9370db, // ãƒŸãƒ‡ã‚£ã‚¢ãƒ ãƒ‘ãƒ¼ãƒ—ãƒ«ã®ç¥ç§˜å…‰
        alpha: 0.15,
      });

      // æœˆã®ã‚¯ãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆã‚ˆã‚Šè©³ç´°ã«ï¼‰
      const craters = new PIXI.Graphics();
      craters.circle(-12, -8, 5);
      craters.circle(10, 3, 7);
      craters.circle(-3, 15, 4);
      craters.circle(18, -10, 3);
      craters.circle(-8, 12, 2);
      craters.fill({
        color: 0xc8d9f0, // å°‘ã—æš—ã‚ã®é’ç™½ã‚¯ãƒ¬ãƒ¼ã‚¿ãƒ¼
        alpha: 0.65,
      });

      // æœˆã®ä½ç½®ï¼ˆå³ä¸Šï¼‰
      moonContainer.x = app.screen.width * 0.85;
      moonContainer.y = app.screen.height * 0.15;

      moonContainer.addChild(glow);
      moonContainer.addChild(moon);
      moonContainer.addChild(craters);

      app.stage.addChild(moonContainer);
      return moonContainer;
    };

    const fantasyMoon = createFantasyMoon();

    // ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ä¸–ç•Œã®å°ã•ãªå²©çŸ³ãƒ»é‰±ç‰©ã‚¢ã‚¯ã‚»ãƒ³ãƒˆ
    for (let i = 0; i < 15; i++) {
      const rockAccent = new PIXI.Graphics();
      const x = Math.random() * app.screen.width;
      const y = app.screen.height * (0.88 + Math.random() * 0.08);
      const size = Math.random() * 1.8 + 0.6;

      rockAccent.circle(x, y, size);
      rockAccent.fill({
        color: 0x4a4a4a, // ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼å²©çŸ³ã‚°ãƒ¬ã‚¤
        alpha: 0.75,
      });
      app.stage.addChild(rockAccent);
    }

    // 6. å®‰å…¨ãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ— - Tickerä½¿ç”¨ã‚’é¿ã‘ã‚‹
    let lastTime = 0;
    const targetFPS = isLowPowerDevice ? 30 : 45;
    const frameInterval = 1000 / targetFPS;
    isAnimating = true; // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åˆ¶å¾¡ãƒ•ãƒ©ã‚°ã‚’æœ‰åŠ¹åŒ–

    // Pixi.jsã®è‡ªå‹•ãƒ†ã‚£ãƒƒã‚«ãƒ¼ã‚’ç„¡åŠ¹åŒ–
    if (app.ticker) {
      app.ticker.autoStart = false;
      app.ticker.stop();
    }

    const animate = (currentTime) => {
      // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åœæ­¢ãƒ•ãƒ©ã‚°ãƒã‚§ãƒƒã‚¯
      if (!isAnimating) {
        return;
      }

      if (typeof document !== "undefined" && document.visibilityState === "hidden") {
        frameId = requestAnimationFrame(animate);
        return;
      }

      // ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆèª¿æ•´
      if (currentTime - lastTime < frameInterval) {
        frameId = requestAnimationFrame(animate);
        return;
      }
      lastTime = currentTime;

      // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒç ´æ£„ã•ã‚Œã¦ã„ãŸã‚‰åœæ­¢
      if (!app || !app.stage) {
        isAnimating = false;
        if (frameId) {
          cancelAnimationFrame(frameId);
          frameId = undefined;
        }
        return;
      }

      // å®‰å…¨ãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
      try {
        // ãƒ‰ãƒ©ã‚¯ã‚¨é¢¨é­”æ³•å…‰ã®ç²’å­ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        particles.forEach(data => {
          const { particle, vx, vy, life } = data;
          if (!particle || !particle.parent) return; // å®‰å…¨ãƒã‚§ãƒƒã‚¯è¿½åŠ 

          particle.x += vx;
          particle.y += vy;

          // ç”»é¢å¤–ã«å‡ºãŸã‚‰åå¯¾å´ã‹ã‚‰å†å‡ºç¾
          if (particle.x > app.screen.width) particle.x = -10;
          if (particle.x < -10) particle.x = app.screen.width;
          if (particle.y > app.screen.height) particle.y = -10;
          if (particle.y < -10) particle.y = app.screen.height;

          // ãƒ‰ãƒ©ã‚¯ã‚¨é¢¨ç¥ç§˜çš„ãªæ˜æ»…åŠ¹æœï¼ˆã‚ˆã‚Šç©ã‚„ã‹ã§é­”æ³•çš„ã«ï¼‰
          particle.alpha = Math.sin(currentTime * 0.0015 * life) * 0.3 + 0.7;
        });

        // ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼æœˆã®å¾®å¦™ãªç¥ç§˜çš„è„ˆå‹•
        if (fantasyMoon && fantasyMoon.parent) {
          const moonPulse = Math.sin(currentTime * 0.0006) * 0.08 + 1;
          fantasyMoon.scale.set(moonPulse);

          // æœˆã®å…‰è¼ªã®è‰²å¤‰åŒ–ï¼ˆç¥ç§˜çš„ãªé’ç´«ã®å¼·å¼±ï¼‰
          if (fantasyMoon.children[0]) {
            const glowAlpha = Math.sin(currentTime * 0.0008) * 0.04 + 0.15;
            fantasyMoon.children[0].alpha = glowAlpha; // glowéƒ¨åˆ†
          }
        }
      } catch (error) {
        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼æ™‚ã¯åœæ­¢
        console.warn('Animation error:', error);
        isAnimating = false;
        if (frameId) {
          cancelAnimationFrame(frameId);
          frameId = undefined;
        }
        return;
      }

      // æ‰‹å‹•ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆTickerã‚’ä½¿ã‚ãªã„ï¼‰
      try {
        if (app && app.renderer && app.stage) {
          app.renderer.render(app.stage);
        }
      } catch (renderError) {
        console.warn('Render error:', renderError);
        isAnimating = false;
        return;
      }

      frameId = requestAnimationFrame(animate);
    };

    // æ—¢å­˜ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‚ã‚Œã°åœæ­¢
    if (frameId) {
      cancelAnimationFrame(frameId);
      frameId = undefined;
    }

    animate(performance.now());
    console.log('ğŸ¬ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹');

  } catch (error) {
    console.error('âŒ æœ¬ç•ªç’°å¢ƒPixiJSåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
    // åˆæœŸåŒ–å¤±æ•—æ™‚ã¯ app ã‚’ null ã«è¨­å®š
    if (app && app.stage) {
      try {
        app.destroy();
      } catch (e) {
        // ç ´æ£„ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
      }
    }
    app = null;

    // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯èƒŒæ™¯ã‚’è¡¨ç¤ºï¼ˆãƒ†ã‚­ã‚¹ãƒˆãªã—ï¼‰
    document.body.style.backgroundColor = '#0E0F13';
  }

  // ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ - PixiJS v8å¯¾å¿œ
  const handleResize = () => {
    try {
      if (app && app.stage && app.renderer) {
        app.renderer.resize(window.innerWidth, window.innerHeight);
        console.log('ğŸ“ ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ');
      }
    } catch (error) {
      console.warn('âš ï¸ ãƒªã‚µã‚¤ã‚ºã‚¨ãƒ©ãƒ¼:', error);
    }
  };

  window.addEventListener('resize', handleResize);

  // å¼·åŒ–ã•ã‚ŒãŸã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ— - Runtime Errorå¯¾ç­–
  const cleanup = () => {
    window.removeEventListener('resize', handleResize);

    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œå…¨åœæ­¢
    isAnimating = false; // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ãƒ©ã‚°ã‚’ç„¡åŠ¹åŒ–
    if (frameId) {
      cancelAnimationFrame(frameId);
      frameId = undefined;
    }

    // Pixi.jsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å®‰å…¨ç ´æ£„
    if (app) {
      try {
        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ—¢ã«ç ´æ£„ã•ã‚Œã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯
        if (app.stage) {
          // ãƒ†ã‚£ãƒƒã‚«ãƒ¼å®Œå…¨åœæ­¢
          if (app.ticker) {
            app.ticker.stop();
            app.ticker.autoStart = false;
          }
          // ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¯ãƒªã‚¢
          if (app.stage) {
            app.stage.removeChildren();
          }
          // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç ´æ£„ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ã«ï¼‰
          app.destroy(true);
        }
      } catch (e) {
        console.warn('âš ï¸ ç ´æ£„ã‚¨ãƒ©ãƒ¼:', e);
      } finally {
        app = null; // ç¢ºå®Ÿã«nullã«è¨­å®š
      }
    }

    console.log('ğŸ§¹ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†');
  };

  // ãƒšãƒ¼ã‚¸ã‚¢ãƒ³ãƒ­ãƒ¼ãƒ‰æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
  window.addEventListener('beforeunload', cleanup);

  console.log('ğŸ® æœ¬ç•ªç’°å¢ƒPixiJSèƒŒæ™¯ èµ·å‹•å®Œäº†ï¼');
}

// åˆæœŸåŒ–å®Ÿè¡Œ
initProductionPixiBackground().catch(console.error);
</script>
</body>
</html>