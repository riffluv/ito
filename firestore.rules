rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isAuthenticated() {
      return request.auth != null;
    }

    function safeText(value, min, max) {
      return value is string
        && value.size() >= min
        && value.size() <= max
        && !value.matches('.*<.*')
        && !value.matches('.*>.*');
    }

    function safeTextAllowEmpty(value, max) {
      return value is string
        && value.size() <= max
        && !value.matches('.*<.*')
        && !value.matches('.*>.*');
    }

    function safeVoteTarget(value) {
      return value is string && value.size() >= 1 && value.size() <= 64;
    }

    function optionalSafeText(value, min, max) {
      return value == null || safeText(value, min, max);
    }

    function isTimestampValue(value) {
      return value == null || value is timestamp;
    }

    function isValidRoomOptions(options) {
      return options is map
        && options.keys().hasOnly(['allowContinueAfterFail', 'resolveMode', 'displayMode', 'defaultTopicType'])
        && options.allowContinueAfterFail is bool
        && options.resolveMode is string
        && options.resolveMode in ['sort-submit']
        && (!('displayMode' in options) || options.displayMode == null || options.displayMode in ['full', 'minimal'])
        && (!('defaultTopicType' in options) || options.defaultTopicType == null || safeText(options.defaultTopicType, 1, 24));
    }

    function isValidOrderMap(order) {
      return order is map
        && order.keys().hasOnly(['list', 'decidedAt', 'lastNumber', 'failed', 'failedAt', 'total', 'proposal', 'numbers', 'snapshots'])
        && (!('list' in order) || (order.list is list && order.list.size() <= 16))
        && (!('proposal' in order) || (order.proposal == null || (order.proposal is list && order.proposal.size() <= 16)))
        && (!('decidedAt' in order) || isTimestampValue(order.decidedAt))
        && (!('lastNumber' in order) || order.lastNumber == null || (order.lastNumber is number && order.lastNumber >= 0 && order.lastNumber <= 120))
        && (!('failed' in order) || order.failed is bool)
        && (!('failedAt' in order) || order.failedAt == null || order.failedAt is number)
        && (!('total' in order) || order.total == null || (order.total is number && order.total >= 0 && order.total <= 16))
        && (!('numbers' in order) || order.numbers == null || order.numbers is map)
        && (!('snapshots' in order) || order.snapshots == null || order.snapshots is map);
    }

    function isValidResultMap(result) {
      return result is map
        && result.keys().hasOnly(['success', 'revealedAt', 'failedAt', 'lastNumber'])
        && result.success is bool
        && (!('revealedAt' in result) || isTimestampValue(result.revealedAt))
        && (!('failedAt' in result) || result.failedAt == null || (result.failedAt is number && result.failedAt >= 0 && result.failedAt <= 50))
        && (!('lastNumber' in result) || result.lastNumber == null || (result.lastNumber is number && result.lastNumber >= 0 && result.lastNumber <= 120));
    }

    function isValidDealMap(deal) {
      return deal is map
        && deal.keys().hasOnly(['seed', 'min', 'max', 'players'])
        && safeText(deal.seed, 1, 64)
        && deal.min is number && deal.min >= 0 && deal.min <= 120
        && deal.max is number && deal.max >= deal.min && deal.max <= 120
        && (!('players' in deal) || (deal.players is list && deal.players.size() <= 16));
    }

    function isValidMvpVotesMap(votes) {
      return votes is map && votes.size() <= 16;
    }

    function isValidRoomDoc(data) {
      return data is map
        && data.keys().hasOnly([
          'name', 'hostId', 'hostName', 'creatorId', 'creatorName', 'options', 'status',
          'createdAt', 'lastActiveAt', 'closedAt', 'expiresAt',
          'topic', 'topicOptions', 'topicBox',
          'order', 'result', 'deal', 'round', 'mvpVotes',
          'requiresPassword', 'passwordHash', 'passwordSalt', 'passwordVersion'
        ])
        && (!('name' in data) || safeText(data.name, 1, 48))
        && (!('hostId' in data) || (data.hostId is string && data.hostId.size() > 0))
        && (!('hostName' in data) || optionalSafeText(data.hostName, 1, 32))
        && (!('creatorId' in data) || (data.creatorId is string && data.creatorId.size() > 0))
        && (!('creatorName' in data) || optionalSafeText(data.creatorName, 1, 32))
        && (!('options' in data) || isValidRoomOptions(data.options))
        && (!('status' in data) || data.status in ['waiting', 'clue', 'reveal', 'finished'])
        && (!('requiresPassword' in data) || data.requiresPassword is bool)
        && (!('passwordHash' in data) || data.passwordHash == null || (data.passwordHash is string && data.passwordHash.size() >= 16 && data.passwordHash.size() <= 128))
        && (!('passwordSalt' in data) || data.passwordSalt == null || (data.passwordSalt is string && data.passwordSalt.size() >= 8 && data.passwordSalt.size() <= 64))
        && (!('passwordVersion' in data) || data.passwordVersion == null || (data.passwordVersion is number && data.passwordVersion >= 0 && data.passwordVersion <= 10))
        && (!(('requiresPassword' in data) && data.requiresPassword)
          || (
            ('passwordHash' in data) && data.passwordHash is string && data.passwordHash.size() >= 16 && data.passwordHash.size() <= 128
            && ('passwordSalt' in data) && data.passwordSalt is string && data.passwordSalt.size() >= 8 && data.passwordSalt.size() <= 64
          ))
        && (!(('requiresPassword' in data) && !data.requiresPassword)
          || (
            (!('passwordHash' in data) || data.passwordHash == null)
            && (!('passwordSalt' in data) || data.passwordSalt == null)
            && (!('passwordVersion' in data) || data.passwordVersion == null)
          ))
        && (!('topic' in data) || data.topic == null || safeText(data.topic, 1, 120))
        && (!('topicOptions' in data) || data.topicOptions == null || (data.topicOptions is list && data.topicOptions.size() <= 12))
        && (!('topicBox' in data) || data.topicBox == null || safeText(data.topicBox, 1, 24))
        && (!('round' in data) || (data.round is number && data.round >= 0 && data.round <= 50))
        && (!('order' in data) || data.order == null || isValidOrderMap(data.order))
        && (!('result' in data) || data.result == null || isValidResultMap(data.result))
        && (!('deal' in data) || data.deal == null || isValidDealMap(data.deal))
        && (!('mvpVotes' in data) || data.mvpVotes == null || isValidMvpVotesMap(data.mvpVotes))
        && (!('createdAt' in data) || data.createdAt is timestamp)
        && (!('lastActiveAt' in data) || data.lastActiveAt is timestamp)
        && (!('closedAt' in data) || isTimestampValue(data.closedAt))
        && (!('expiresAt' in data) || isTimestampValue(data.expiresAt));
    }

    function isValidPlayerDoc(data) {
      return data is map
        && data.keys().hasOnly(['name', 'avatar', 'number', 'clue1', 'ready', 'orderIndex', 'uid', 'lastSeen', 'joinedAt'])
        && safeText(data.name, 1, 24)
        && safeTextAllowEmpty(data.avatar, 64)
        && (data.number == null || (data.number is number && data.number >= 0 && data.number <= 120))
        && safeTextAllowEmpty(data.clue1, 120)
        && data.ready is bool
        && data.orderIndex is number && data.orderIndex >= 0 && data.orderIndex <= 20
        && (!('uid' in data) || optionalSafeText(data.uid, 1, 64))
        && (!('lastSeen' in data) || isTimestampValue(data.lastSeen))
        && (!('joinedAt' in data) || isTimestampValue(data.joinedAt));
    }

    function isValidChatDoc(data) {
      return data is map
        && data.keys().hasOnly(['sender', 'uid', 'text', 'createdAt'])
        && safeText(data.sender, 1, 32)
        && optionalSafeText(data.uid, 1, 64)
        && safeText(data.text, 1, 500)
        && data.text.matches('(?s).*\\S.*')
        && data.createdAt is timestamp;
    }

    match /rooms/{roomId} {
      allow read: if isAuthenticated();

      allow create: if isAuthenticated()
        && request.auth.uid == request.resource.data.hostId
        && isValidRoomDoc(request.resource.data)
        && request.resource.data.status == 'waiting';

      allow update: if isAuthenticated() && (
          // ホスト/管理者の通常更新（ベースライン）
          ((isHost(roomId) || isAdmin())
            && isValidHostAssignment(roomId))
          // 一般参加者: clue中のみ、order.* と lastActiveAt だけを変更（差分ベース）
          || (getRoomStatus(roomId) == 'clue'
            && onlyOrderAndLastActiveChanged()
            && orderChangeKeysAreSafe())
          // カスタムお題モード時、参加者によるお題更新を許可
          || canParticipantUpdateCustomTopic(roomId)
          // ゲーム終了後のMVP投票
          || canParticipantCastMvpVote(roomId)
        );

      allow delete: if isAuthenticated() && (isHost(roomId) || isAdmin());

      match /players/{playerId} {
        allow read: if isAuthenticated();

        allow create: if isAuthenticated()
          && request.auth.uid == playerId
          && request.resource.data.uid == request.auth.uid
          && (isWaiting(roomId) || isHost(roomId) || isAdmin())
          && isValidPlayerDoc(request.resource.data);

        allow update: if isAuthenticated()
          && (
            // 本人による更新
            (request.auth.uid == resource.data.uid
              && request.resource.data.uid == resource.data.uid
              && isValidPlayerDoc(request.resource.data)
              && (
                !('name' in request.resource.data) || resource.data.name == request.resource.data.name || isWaiting(roomId) || isHost(roomId)
              )
              && (
                !('number' in request.resource.data)
                || resource.data.number == request.resource.data.number
                || (getRoomStatus(roomId) in ['clue', 'reveal'])
              ))
            // ホストによるゲーム状態リセット（特定フィールドのみ）
            || (isHost(roomId)
              && request.resource.data.uid == resource.data.uid // UID変更不可
              && request.resource.data.name == resource.data.name // 名前変更不可
              && request.resource.data.avatar == resource.data.avatar // アバター変更不可
              && isValidPlayerDoc(request.resource.data)
              && resource.data.keys().hasAll(['uid', 'name', 'avatar']) // 必須フィールド確認
            )
          );

        allow delete: if isAuthenticated() && request.auth.uid == resource.data.uid;
      }

      match /chat/{msgId} {
        allow read: if isAuthenticated();

        allow create: if isAuthenticated()
          && isValidChatDoc(request.resource.data)
          && (
            (request.resource.data.sender == 'system' && (isHost(roomId) || isAdmin()))
            || (request.resource.data.sender != 'system' && request.resource.data.uid == request.auth.uid)
          );

        allow update: if false;
        allow delete: if false;
      }

      // 通知イベント（右上トースト用）
      match /events/{eventId} {
        allow read: if isAuthenticated();

        allow create: if isAuthenticated()
          && (isHost(roomId) || isAdmin())
          && isValidEventDoc(request.resource.data);

        allow update: if false;
        allow delete: if false;
      }
    }

    function isWaiting(roomId) {
      return get(/databases/$(database)/documents/rooms/$(roomId)).data.status == 'waiting';
    }
    function isHost(roomId) {
      return get(/databases/$(database)/documents/rooms/$(roomId)).data.hostId == request.auth.uid;
    }
    function isAdmin() {
      return request.auth != null && request.auth.token.admin == true;
    }
    function getRoomStatus(roomId) {
      return get(/databases/$(database)/documents/rooms/$(roomId)).data.status;
    }
    // (unused) 旧ロジックの名残は削除（警告軽減）
    function isValidEventDoc(data) {
      return data is map
        && data.keys().hasOnly(['kind','type','title','description','createdAt'])
        && data.kind == 'notify'
        && data.type is string && data.type in ['info','warning','success','error']
        && safeText(data.title, 1, 80)
        && (!('description' in data) || data.description == null || safeTextAllowEmpty(data.description, 200))
        && isTimestampValue(data.createdAt);
    }
    // ホスト入れ替え時の妥当性（従来どおり）
    function hostCandidateIsValid(roomId, candidate) {
      return exists(/databases/$(database)/documents/rooms/$(roomId)/players/$(candidate))
        && get(/databases/$(database)/documents/rooms/$(roomId)/players/$(candidate)).data.uid == candidate;
    }

    function isValidHostAssignment(roomId) {
      return !('hostId' in request.resource.data)
        || (
          request.resource.data.hostId is string
          && request.resource.data.hostId.size() > 0
          && ((('hostId' in resource.data) && request.resource.data.hostId == resource.data.hostId)
            || hostCandidateIsValid(roomId, request.resource.data.hostId))
        );
    }

    function isParticipant(roomId) {
      return exists(/databases/$(database)/documents/rooms/$(roomId)/players/$(request.auth.uid));
    }

    function canParticipantUpdateCustomTopic(roomId) {
      return isParticipant(roomId)
        && getRoomStatus(roomId) in ['waiting','clue']
        && request.resource.data.topicBox == 'カスタム'
        && safeText(request.resource.data.topic, 1, 120)
        && (!('topicOptions' in request.resource.data) || request.resource.data.topicOptions == null)
        && request.resource.data.diff(resource.data).changedKeys().hasOnly(['topic','topicOptions','topicBox'])
        && (!('topicBox' in resource.data)
          || resource.data.topicBox == null
          || resource.data.topicBox == 'カスタム');
    }

    function canParticipantCastMvpVote(roomId) {
      let voterField = 'mvpVotes.' + request.auth.uid;
      let fields = request.writeFields;
      let allowedFields = fields.hasOnly([voterField])
        || fields.hasOnly([voterField, 'lastActiveAt']);
      let nextHasVote = request.resource.data.keys().hasAny(['mvpVotes'])
        && request.resource.data.mvpVotes is map
        && request.resource.data.mvpVotes.keys().hasAny([request.auth.uid]);
      return isParticipant(roomId)
        && getRoomStatus(roomId) == 'finished'
        && allowedFields
        && (
          !nextHasVote
          || safeVoteTarget(request.resource.data.mvpVotes[request.auth.uid])
        );
    }

    // トップレベル差分: order と lastActiveAt 以外は変えていないこと
    function onlyOrderAndLastActiveChanged() {
      return resource.data.diff(request.resource.data).changedKeys().hasOnly(['order','lastActiveAt']);
    }
    // order の差分: proposal のみ（互換で total 同時更新も可）
    function orderChangeKeysAreSafe() {
      return request.resource.data.order.diff(resource.data.order).changedKeys().hasOnly(['proposal'])
        || request.resource.data.order.diff(resource.data.order).changedKeys().hasOnly(['proposal','total']);
    }
  }
}

