# 次担当エージェントへの依頼

## 背景
- これまでのフロー: ホストが「ゲームを開始」→プレイ→終了後に「もう一度」ボタンで待機状態へ戻し、その後再度「ゲームを開始」していた。
- 友人からの要望で、現在は「次のゲーム」ボタンを押したら即座に次ラウンドへ進む仕様に変更した。
- 仕様変更後、ホスト画面で「次のゲーム」を押した瞬間に `room.status` が一瞬 `waiting` に戻るためか、`ゲーム開始` ボタンが一瞬表示され、実際に押下可能な状態になる問題が残っている。

## 現象
1. Firebase Emulator Suite（もしくは本番環境でも再現）で部屋を作り、ホストとしてゲームを開始。
2. 1ラウンド完了後に「次のゲーム」ボタンを押す。
3. `せーの！`（clue フェーズ）に遷移する前のほんの一瞬、右下ホスト操作エリアに「ゲーム開始」ボタンが表示され、しかも押下できる。
4. その後 `せーの！` ボタンが表示され、ゲーム自体は正常に進行する。

## 期待する挙動
- 「次のゲーム」押下後はローディング表示（例: `準備中`）のまま遷移し、`ゲーム開始` ボタンが途中で見えたり押せたりしないこと。
- ホストから見える操作エリアは常に一貫した CTA だけを表示し、UX を阻害しない。

## 関連コード
- `components/ui/MiniHandDock.tsx`
  - 現在のホスト操作 UI 本体。`isQuickStarting` / `autoStartPending` / `autoStarting` フラグで抑制を試み済み。
- `app/rooms/[roomId]/page.tsx`
  - `MiniHandDock` への props 渡しと、`ito:host-restart` カスタムイベント送信。
- `components/hooks/useHostActions.ts`
  - ホスト操作モデルを組み立てる。`quickStart` / `primary` アクションの条件を確認したい。
- `lib/host/hostActionsModel.ts`
  - ステータス別にアクションを返す純粋ロジック。`status === "waiting"` などの条件で `quickStart` が返る。
- `components/ui/HostControlDock.tsx`
  - 右上（もしくは別 UI）からホスト操作を出している場合に同じボタンが生成されていないか要確認。

## 現状の対策と課題
- `MiniHandDock` に `autoStarting` フラグを導入し、Firestore ドキュメントに `autoStarting: true/false` を書き込むことでボタン表示を抑制しようとしたが、依然として `ゲーム開始` ボタンが一瞬表示される。
- `showStartButton` 条件は `roomStatus === "waiting"` かつ各種フラグが false のときのみ描画するようにしているが、別経路からボタンが挿入されている可能性が高い。
- `useHostActions` で返される `quickStart` がどこか別 UI（HUD 等）で描画されているかもしれない。`HostControlDock` 側で disabled ではなく `AppButton` 自体が残っていることも疑わしい。
- Firestore の `autoStarting` フィールド更新がクライアント間で即時反映されないタイミングがあり、描画条件の race を完全に防げていない可能性もある。

## 次担当者への依頼内容
- ホスト視点の UI を俯瞰して、「ゲーム開始」ボタンがどのコンポーネント経由で描画されているか全て洗い出してください。
- `MiniHandDock` 以外にボタンを出しているコンポーネントがあれば同様に制御し、1 つの状態マシン（例えば `room.status` と `autoStarting`）で整合的に管理できるようにしてください。
- Firestore のドキュメントフィールドに依存する場合は、遅延でボタンが一瞬表示されないよう、ローカル状態や React コンテキストなどで先にロックする仕組みを検討してください。
- 可能であれば e2e 的な再現手順と、修正後の確認方法をドキュメント化してください。

## 留意点
- 既存のゲーム進行ロジック（`room.status` の遷移、`topicControls`、`resetRoomWithPrune` など）を壊さないこと。
- ホストとゲストで表示が異なるため、両者の UI を確認してください。
- 変更が大きくなる場合は、再利用性の高い状態管理（例: カスタムフックや Zustand など）を検討する価値があります。
- 対話は日本語でお願いしています。

## 補足情報
- 現在のブランチはローカルでのみ作業中（未コミットの差分有り）。
- `autoStarting` フィールドはまだ本番 Firestore ルールに追加していません。新フィールドを使う場合はルール更新も合わせて検討してください。
