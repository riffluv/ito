<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Halloween Background (PixiJS)</title>

  <!-- PixiJS -->
  <script src="https://cdn.jsdelivr.net/npm/pixi.js@7.4.0/dist/pixi.min.js"></script>

  <style>
    /* 画面いっぱいの背景キャンバス。上にアプリUIを重ねて使えるよう pointer-events: none */
    html, body { height: 100%; margin: 0; }
    body { background: #0b104f; }
    #bg-root {
      position: fixed; inset: 0;
      z-index: 0;
      pointer-events: none;
      overflow: hidden;
    }
    /* もし、あなたのアプリUIがposition未指定なら通常フローのままでOK。
       position要素を重ねる場合は z-index を 1 以上にしてね。*/
  </style>
</head>
<body>
  <!-- 背景だけ -->
  <div id="bg-root" aria-hidden="true"></div>

  <script>
  (function(){
    'use strict';

    const root = document.getElementById('bg-root');
    const prefersReducedMotion = matchMedia('(prefers-reduced-motion: reduce)').matches;

    const app = new PIXI.Application({
      resizeTo: root,
      backgroundAlpha: 0,
      antialias: true,
      autoDensity: true,
    });
    root.appendChild(app.view);

    const scene = new PIXI.Container();
    app.stage.addChild(scene);

    // ---- レイヤー
    const L = {
      sky: new PIXI.Container(),
      starsFar: new PIXI.ParticleContainer(300, { scale: true, alpha: true }),
      clouds: new PIXI.Container(),
      moon: new PIXI.Container(),
      starsNear: new PIXI.ParticleContainer(120, { scale: true, alpha: true }),
      hills: new PIXI.Container(),
      house: new PIXI.Container(),
      pumpkins: new PIXI.Container(),
      bats: new PIXI.Container(),
      candies: new PIXI.Container(),
      garland: new PIXI.Container(),
      vignette: new PIXI.Container(),
    };
    scene.addChild(
      L.sky, L.starsFar, L.clouds, L.moon, L.starsNear,
      L.hills, L.house, L.pumpkins, L.bats, L.candies, L.garland, L.vignette
    );

    // ---- ユーティリティ
    const rand = (a,b)=> a + Math.random()*(b-a);
    const choice = arr => arr[(Math.random()*arr.length)|0];

    function vGradientTex(stops){
      const c = document.createElement('canvas');
      c.width = 2; c.height = 512;
      const ctx = c.getContext('2d');
      const g = ctx.createLinearGradient(0,0,0,512);
      stops.forEach(([p, col])=> g.addColorStop(p, col));
      ctx.fillStyle = g; ctx.fillRect(0,0,2,512);
      return PIXI.Texture.from(c);
    }
    function starTex(r=2.2){
      const g = new PIXI.Graphics();
      g.beginFill(0xffffff).drawCircle(r, r, r).endFill();
      const t = app.renderer.generateTexture(g);
      g.destroy(true);
      return t;
    }

    // ---- パレット（かわいい夜空）
    const palette = {
      sky: [
        [0,   '#5422a6'],
        [0.5, '#2a197f'],
        [1,   '#0b104f']
      ],
      stars: 0xffffff,
      candy: [0xffc6e3, 0xa2e1ff, 0xe8ff9a, 0xffd166],
      bat: 0x1b143d,
      pumpkin: 0xff8c42,
    };

    // ---- 空
    const sky = new PIXI.TilingSprite(vGradientTex(palette.sky), app.screen.width, app.screen.height);
    L.sky.addChild(sky);

    // ---- 月（ちょいかわ）
    const moon = new PIXI.Container();
    const r = 64;
    const mBody = new PIXI.Graphics().beginFill(0xffd166).drawCircle(0,0,r).endFill();
    const cr = new PIXI.Graphics().beginFill(0xf7be66, .6);
    for(let i=0;i<6;i++){
      const rr = rand(6,12), a = Math.random()*Math.PI*2, d = rand(10, r-rr-10);
      cr.drawCircle(Math.cos(a)*d, Math.sin(a)*d, rr);
    }
    cr.endFill();
    const face = new PIXI.Graphics().beginFill(0x1b143d);
    face.drawCircle(-20,-10,6); face.drawCircle(20,-10,6);
    face.moveTo(-16,12); face.quadraticCurveTo(0,24,16,12); face.endFill();
    moon.addChild(mBody, cr, face);
    L.moon.addChild(moon);

    // ---- 星
    const starT = starTex(2.2);
    const starsMeta = [];
    function populateStars(){
      L.starsFar.removeChildren(); L.starsNear.removeChildren(); starsMeta.length=0;
      const W = app.screen.width, H = app.screen.height;
      const farN = Math.round(Math.max(120, W*H/14000));
      const nearN = Math.round(Math.max(60,  W*H/28000));
      for(let i=0;i<farN;i++){
        const s = new PIXI.Sprite(starT);
        s.tint = palette.stars; s.alpha = rand(.35,.8); s.scale.set(rand(.25,.7));
        s.position.set(Math.random()*W, Math.random()*H*.6);
        L.starsFar.addChild(s); starsMeta.push({s, w:rand(.002,.005), off:Math.random()*6.28});
      }
      for(let i=0;i<nearN;i++){
        const s = new PIXI.Sprite(starT);
        s.tint = palette.stars; s.alpha = rand(.5,.95); s.scale.set(rand(.8,1.6));
        s.position.set(Math.random()*W, Math.random()*H*.55);
        L.starsNear.addChild(s); starsMeta.push({s, w:rand(.003,.007), off:Math.random()*6.28});
      }
    }

    // ---- 雲
    function cloud(w=240,h=80,a=.14){
      const g = new PIXI.Graphics();
      g.beginFill(0xffffff, a);
      g.drawEllipse(0,0,w*.35,h*.45);
      g.drawEllipse(20,0,w*.42,h*.5);
      g.drawEllipse(-28,6,w*.4,h*.4);
      g.endFill(); return g;
    }
    const clouds = [];
    function populateClouds(){
      L.clouds.removeChildren(); clouds.length=0;
      const W = app.screen.width, H = app.screen.height, n = Math.max(3, Math.round(W/480));
      for(let i=0;i<n;i++){
        const c = cloud(rand(220,360), rand(70,120), .12);
        c.position.set(Math.random()*W, rand(40, H*.4));
        c.alpha *= rand(.7,1); L.clouds.addChild(c);
        clouds.push({c, spd: rand(.03,.06), drift: rand(.8,1.6)});
      }
    }

    // ---- 丘シルエット & おばけハウス
    function drawHills(){
      L.hills.removeChildren();
      const {width:W, height:H} = app.screen, g = new PIXI.Graphics();
      g.beginFill(0x0a0b28, .88);
      g.moveTo(0,H); const base = H*.84;
      g.bezierCurveTo(W*.2, base-40, W*.35, base-10, W*.5, base-30);
      g.bezierCurveTo(W*.65, base-50, W*.8, base-10, W, base-24);
      g.lineTo(W,H).closePath().endFill();
      L.hills.addChild(g);
    }
    function drawHouse(){
      L.house.removeChildren();
      const {width:W, height:H} = app.screen;
      const x=W*.14, y=H*.72, s=Math.max(1, Math.min(1.8, W/1200));
      const g = new PIXI.Graphics();
      g.beginFill(0x0a0b28,.95)
       .drawPolygon([x,y, x+60*s,y-40*s, x+120*s,y, x+110*s,y, x+110*s,y+80*s, x+10*s,y+80*s, x+10*s,y])
       .endFill();
      const win = new PIXI.Graphics();
      win.beginFill(0xffd98a,.85).drawRoundedRect(x+44*s, y+20*s, 24*s, 28*s, 6*s).endFill();
      L.house.addChild(g, win);
    }

    // ---- かぼちゃの列（手前）
    function pumpkin(scale=1, tint=palette.pumpkin){
      const c = new PIXI.Container(); c.scale.set(scale);
      const b = new PIXI.Graphics();
      b.beginFill(tint).drawEllipse(0,0,28,22).drawEllipse(-14,0,20,18).drawEllipse(14,0,20,18).endFill();
      const stem = new PIXI.Graphics().beginFill(0x6d9e3c).drawRoundedRect(-4,-20,8,10,3).endFill();
      const face = new PIXI.Graphics().beginFill(0x1b143d);
      face.drawPolygon([-9,-2,-2,-10,5,-2]).drawPolygon([9,-2,2,-10,-5,-2]).drawRoundedRect(-12,3,24,6,3).endFill();
      c.addChild(b, stem, face); return c;
    }
    const pumpkins = [];
    function populatePumpkins(){
      L.pumpkins.removeChildren(); pumpkins.length=0;
      const {width:W,height:H} = app.screen, n = Math.max(5, Math.round(W/220));
      for(let i=0;i<n;i++){
        const p = pumpkin(rand(.8,1.2));
        p.x = (i + Math.random()*0.6) * (W/n);
        p.y = H*.86 + rand(-4,4);
        L.pumpkins.addChild(p);
        pumpkins.push({p, off: Math.random()*6.28, amp: rand(1.5,4)});
      }
    }

    // ---- コウモリ
    function batShape(tint){
      const g = new PIXI.Graphics().beginFill(tint,1);
      g.moveTo(0,0);
      g.bezierCurveTo(-16,-8, -28,-12, -36,0);
      g.bezierCurveTo(-14,6, -8,12, 0,8);
      g.bezierCurveTo(8,12, 14,6, 36,0);
      g.bezierCurveTo(28,-12, 16,-8, 0,0);
      g.endFill(); return g;
    }
    const bats = [];
    function populateBats(){
      L.bats.removeChildren(); bats.length=0;
      const {width:W,height:H} = app.screen;
      const n = 7;
      for(let i=0;i<n;i++){
        const b = batShape(palette.bat);
        b.scale.set(rand(.55,1.0));
        b.position.set(Math.random()*W, rand(H*.1, H*.45));
        L.bats.addChild(b);
        bats.push({b, spd: rand(.6,1.2), amp: rand(8,18), baseY:b.y, dir: Math.random()>.5?1:-1, t: Math.random()*6.28});
      }
    }

    // ---- キャンディ（ふわふわ上昇）
    function candy(color){
      const c = new PIXI.Container();
      const body = new PIXI.Graphics().beginFill(color).drawRoundedRect(-10,-6,20,12,6).endFill();
      const wrap = new PIXI.Graphics().beginFill(color, .85);
      wrap.drawPolygon([-14,-2,-24,-6,-22,0,-24,6,-14,2]);
      wrap.drawPolygon([14,-2,24,-6,22,0,24,6,14,2]);
      wrap.endFill(); c.addChild(wrap, body); return c;
    }
    const candies = [];
    function populateCandies(){
      L.candies.removeChildren(); candies.length=0;
      const {width:W,height:H} = app.screen;
      const n = Math.round(Math.max(24, W/60));
      for(let i=0;i<n;i++){
        const c = candy(choice(palette.candy)); c.alpha = rand(.55,.95);
        const sc = rand(.6,1.2); c.scale.set(sc);
        c.position.set(Math.random()*W, rand(H*.52, H*.98));
        L.candies.addChild(c);
        candies.push({c, spd: rand(.25,.6), rot: rand(-.02,.02)});
      }
    }

    // ---- ガーランド（上部のランタン列）
    function drawGarland(){
      L.garland.removeChildren();
      const {width:W,height:H} = app.screen, y = H*.11;
      const g = new PIXI.Graphics().lineStyle(2, 0xffffff, .22);
      g.moveTo(0,y); g.quadraticCurveTo(W*.5, y+30, W, y); L.garland.addChild(g);
      const n = Math.max(6, Math.round(W/180));
      for(let i=0;i<n;i++){
        const t = i/(n-1), x=t*W, yy = y + Math.sin(Math.PI*t)*30;
        const lamp = pumpkin(.4, 0xffa047); lamp.position.set(x, yy+10); lamp._tw = Math.random()*6.28;
        L.garland.addChild(lamp);
      }
    }

    // ---- ビネット（中央を引き立て）
    function drawVignette(){
      L.vignette.removeChildren();
      const {width:W,height:H} = app.screen;
      const cnv = document.createElement('canvas'); cnv.width=W; cnv.height=H;
      const ctx = cnv.getContext('2d');
      const rad = Math.max(W,H)*.65;
      const grad = ctx.createRadialGradient(W/2,H*.55, rad*.2, W/2,H*.55, rad);
      grad.addColorStop(0,'rgba(0,0,0,0)');
      grad.addColorStop(1,'rgba(0,0,0,0.55)');
      ctx.fillStyle = grad; ctx.fillRect(0,0,W,H);
      const spr = new PIXI.Sprite(PIXI.Texture.from(cnv));
      spr.blendMode = PIXI.BLEND_MODES.MULTIPLY;
      L.vignette.addChild(spr);
    }

    // ---- レイアウト／リサイズ
    function layout(){
      const {width:W, height:H} = app.screen;
      sky.width=W; sky.height=H;
      moon.position.set(W*.8, H*.22);

      drawHills(); drawHouse(); drawGarland(); drawVignette();
      populateStars(); populateClouds(); populatePumpkins(); populateBats(); populateCandies();
    }
    layout();

    // ---- アニメーション
    let t = 0;
    app.ticker.add((delta)=>{
      if (prefersReducedMotion) return;
      t += delta;

      // 雲
      for(const cl of (L.clouds.children.map(c=>({c, spd:.04, drift:1.1})))){}
      for(const cl of L.clouds.children){
        cl.x += .04*delta;
        cl.y += Math.sin(t*.01 + cl.x*0.001)*0.1;
        if (cl.x > app.screen.width + 200) cl.x = -200;
      }

      // 星
      for (const meta of starsMeta){
        meta.s.alpha = .55 + Math.sin(meta.off + t*meta.w)*.45;
      }

      // かぼちゃ
      for (const pk of L.pumpkins.children){
        pk.y += Math.sin(t*.06 + pk.x*0.01)*.08;
      }

      // コウモリ
      for(const b of L.bats.children){
        if(!b._meta){
          b._meta = { dir: Math.random()>.5?1:-1, spd: rand(.6,1.2), amp: rand(8,18), baseY: b.y, t: Math.random()*6.28 };
        }
        const m = b._meta;
        m.t += .05*m.spd;
        b.x += m.spd*m.dir*1.8;
        b.y = m.baseY + Math.sin(m.t)*m.amp;
        if (b.x < -60){ m.dir=1; b.x = app.screen.width+40; m.baseY = rand(app.screen.height*.1, app.screen.height*.5); }
        if (b.x > app.screen.width+60){ m.dir=-1; b.x = -40; m.baseY = rand(app.screen.height*.1, app.screen.height*.5); }
        b.scale.x = m.dir;
      }

      // キャンディ
      for(const c of L.candies.children){
        if(!c._meta){ c._meta={ spd: rand(.25,.6), rot: rand(-.02,.02) }; }
        const m = c._meta;
        c.y -= m.spd*delta; c.rotation += m.rot*delta;
        if (c.y < -20){ c.y = app.screen.height + rand(0,100); c.x = rand(0, app.screen.width); }
      }

      // ガーランド明滅
      for (const lamp of L.garland.children){
        if (lamp === L.garland.children[0]) continue; // 最初の線はスキップ
        lamp.alpha = .85 + Math.sin((lamp._tw||0) + t*.02)*.15;
      }
    });

    // ---- 画面サイズ追従
    const ro = new ResizeObserver(() => layout());
    ro.observe(root);

    // ---- 便利：背景PNGを取得したい時用（必要な時だけ呼び出す）
    // window.__exportHalloweenBg = () => app.renderer.extract.base64(scene, 'image/png');
  })();
  </script>
</body>
</html>
