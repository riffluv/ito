<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ito_game_professional + ホストパネル（ラッパーモック）</title>
    <style>
      :root {
        --bg: #0b1020; --text: #e5e7eb; --muted: #a7b0c0;
        --panel: #111833; --card: #18244d; --border: rgba(255,255,255,.08);
        --accent: #3b82f6; /* normal */
        --danger: #ef4444;
        --gap-1: 8px; --gap-2: 16px; --gap-3: 24px; --gap-4: 32px;
      }
      body { margin: 0; background: var(--bg); color: var(--text); font: 14px/1.6 system-ui, -apple-system, Segoe UI, Roboto, "ヒラギノ角ゴ ProN", Meiryo, sans-serif; }
      .layout { display: grid; grid-template-columns: 1fr 360px; min-height: 100vh; }
      .game-wrap { position: relative; background: #000; }
      .game-frame { width: 100%; height: 100vh; border: 0; display: block; background: #000; }
      .overlay { pointer-events: none; position: absolute; inset: 0; display: grid; place-items: center; }
      .number { width: 220px; height: 220px; border-radius: 50%; display: grid; place-items: center; font-size: 72px; font-weight: 800; color: white; background: radial-gradient(circle at 30% 30%, #ffffff, var(--accent)); box-shadow: 0 10px 30px rgba(0,0,0,0.4); transform: translateZ(0); opacity: .95; }
      .number.bump { animation: bump 520ms cubic-bezier(.2,.8,.2,1); }
      @keyframes bump { 0%{ transform: scale(.8); } 60%{ transform: scale(1.12); } 100%{ transform: scale(1); } }
      .hint { position: absolute; bottom: 14px; left: 14px; color: var(--muted); background: rgba(0,0,0,.35); padding: 6px 8px; border-radius: 8px; font-size: 12px; }

      .panel { background: var(--panel); border-left: 1px solid var(--border); padding: var(--gap-3); display: grid; grid-template-rows: auto auto 1fr auto; gap: var(--gap-3); }
      .row { display: grid; gap: var(--gap-2); }
      .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: var(--gap-2); }
      .card h3 { margin: 0 0 6px; font-size: 14px; color: var(--muted); letter-spacing: .3px; }
      .topic { font-size: 20px; font-weight: 800; }
      .progress { color: var(--muted); font-variant-numeric: tabular-nums; }
      .history { display: flex; flex-wrap: wrap; gap: 8px; }
      .chip { padding: 4px 10px; border-radius: 999px; border: 1px solid var(--border); background: rgba(255,255,255,.06); }

      .btn { appearance: none; border: 1px solid var(--border); background: #0f1838; color: #e8eefc; padding: 10px 14px; border-radius: 10px; font-weight: 700; cursor: pointer; transition: transform .03s ease, background .15s; }
      .btn:hover { background: #12204a; }
      .btn:active { transform: translateY(1px); }
      .btn[disabled] { opacity: .5; cursor: not-allowed; }
      .btn.primary { border: 0; background: var(--accent); color: #fff; box-shadow: 0 10px 18px rgba(59,130,246,.25); padding: 12px 18px; font-size: 16px; border-radius: 999px; }
      .btn.danger { border-color: rgba(239,68,68,.4); color: #fff; background: rgba(239,68,68,.15); }
      .btn.danger:hover { background: rgba(239,68,68,.22); }

      .segment { display: inline-flex; background: #0e1633; border: 1px solid var(--border); border-radius: 999px; overflow: hidden; }
      .segment button { appearance: none; border: 0; padding: 8px 12px; color: var(--muted); background: transparent; cursor: pointer; font-weight: 700; letter-spacing: .2px; }
      .segment button[aria-pressed="true"] { color: #fff; background: var(--accent); }
      .segment button:not([aria-pressed="true"]):hover { background: rgba(255,255,255,0.06); }

      dialog { border: 1px solid var(--border); border-radius: 12px; padding: 0; background: var(--panel); color: var(--text); }
      dialog::backdrop { background: rgba(0,0,0,.5); backdrop-filter: blur(2px); }
      .dlg-head { padding: 12px 16px; border-bottom: 1px solid var(--border); font-weight: 700; }
      .dlg-body { padding: 14px 16px; display: grid; gap: 12px; }
      .dlg-foot { padding: 12px 16px; display: flex; gap: 8px; justify-content: flex-end; border-top: 1px solid var(--border); }
      .topic-list { display: grid; gap: 8px; max-height: 40vh; overflow: auto; }
      .topic-item { display: flex; align-items: center; gap: 8px; padding: 6px 8px; border-radius: 8px; background: rgba(255,255,255,0.04); cursor: pointer; }
      .topic-item input { accent-color: var(--accent); }

      /* カテゴリごとの色調 */
      body.mode-normal { --accent: #3b82f6; }
      body.mode-rainbow { --accent: #8b5cf6; }
      body.mode-classic { --accent: #94a3b8; }

      @media (max-width: 1000px) { .layout { grid-template-columns: 1fr; } .game-frame { height: 60vh; } }
    </style>
  </head>
  <body>
    <div class="layout">
      <!-- 左: 既存ゲーム画面（変更なし、iframeで読み込み） -->
      <section class="game-wrap" aria-label="ゲーム画面">
        <iframe class="game-frame" src="../docs/mocks/ito_game_professional.html" title="ゲーム画面"></iframe>
        <div class="overlay" aria-live="polite" aria-atomic="true">
          <div id="overlayNumber" class="number">–</div>
          <div class="hint">Space/Enter=配る, S=シャッフル, T=お題変更, Ctrl+R=リセット</div>
        </div>
      </section>

      <!-- 右: ホスト操作パネル（今回の実装） -->
      <aside class="panel" aria-label="ホスト操作パネル">
        <div class="row">
          <div class="card">
            <h3>フロー</h3>
            <div style="display:flex; gap:8px; align-items:center; flex-wrap: wrap;">
              <button id="btnStart" class="btn primary">開始</button>
              <div class="segment" role="tablist" aria-label="カテゴリ">
                <button class="seg" data-cat="normal" aria-pressed="false">通常</button>
                <button class="seg" data-cat="rainbow" aria-pressed="false">レインボー</button>
                <button class="seg" data-cat="classic" aria-pressed="false">クラシック</button>
              </div>
              <span id="progressText" class="progress">未開始</span>
              <span id="catPill" class="progress" style="display:none;">カテゴリ: —</span>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="card">
            <h3>アクション</h3>
            <div style="display:flex; gap:8px; flex-wrap: wrap;">
              <button id="btnShuffle" class="btn" disabled>シャッフル</button>
              <button id="btnDraw" class="btn primary" disabled>数字を選ぶ</button>
              <button id="btnTopic" class="btn" disabled>お題を選びなおす</button>
              <button id="btnReset" class="btn danger" style="margin-left:auto;">リセット</button>
            </div>
          </div>
          <div class="card">
            <h3>お題</h3>
            <div id="topicText" class="topic">（未選択）</div>
          </div>
        </div>

        <div class="row">
          <div class="card">
            <h3>履歴</h3>
            <div id="history" class="history" aria-live="polite"></div>
          </div>
        </div>

        <div class="row">
          <div class="progress">ショートカット: Space/Enter=配る, S=シャッフル, T=お題変更, Ctrl+R=リセット</div>
        </div>
      </aside>
    </div>

    <!-- お題選択ダイアログ（カテゴリ切替込み） -->
    <dialog id="topicDialog">
      <div class="dlg-head">お題を選びなおす</div>
      <form method="dialog">
        <div class="dlg-body">
          <div class="segment" id="topicSeg" role="tablist" aria-label="カテゴリ">
            <button class="segCat" data-cat="normal" aria-pressed="false">通常</button>
            <button class="segCat" data-cat="rainbow" aria-pressed="false">レインボー</button>
            <button class="segCat" data-cat="classic" aria-pressed="false">クラシック</button>
          </div>
          <div class="topic-list" id="topicList"></div>
        </div>
        <div class="dlg-foot">
          <button value="cancel" class="btn">キャンセル</button>
          <button id="topicOk" value="ok" class="btn primary">決定</button>
        </div>
      </form>
    </dialog>

    <script>
      // ===== 状態 =====
      const state = {
        started: false,
        category: null, // 'normal' | 'rainbow' | 'classic'
        topic: null,
        topicsByCategory: {
          normal: ['動物','食べ物','スポーツ','映画','音楽','国','職業','科学','季節','色'],
          rainbow: ['赤いもの','青いもの','緑のもの','カラフルな服','虹色の物','光るもの','ペイント','花','宝石','キャンディ'],
          classic: ['将棋','トランプ','チェス','ことわざ','名作文学','古典音楽','歴史人物','名画','世界遺産','伝統行事']
        },
        pool: [],
        drawn: [],
        max: 75
      };

      // ===== 要素 =====
      const $ = (s) => document.querySelector(s);
      const $$ = (s) => Array.from(document.querySelectorAll(s));
      const el = {
        overlayNumber: $('#overlayNumber'),
        btnStart: $('#btnStart'),
        segs: $$('.segment .seg'),
        btnDraw: $('#btnDraw'), btnShuffle: $('#btnShuffle'), btnTopic: $('#btnTopic'), btnReset: $('#btnReset'),
        progress: $('#progressText'), catPill: $('#catPill'),
        topicText: $('#topicText'), history: $('#history'),
        topicDialog: $('#topicDialog'), topicList: $('#topicList'), topicOk: $('#topicOk'), topicSeg: $('#topicSeg')
      };

      // ===== 初期化 =====
      function init(){
        resetPool();
        el.btnStart.addEventListener('click', onStart);
        el.btnReset.addEventListener('click', onReset);
        el.btnDraw.addEventListener('click', onDraw);
        el.btnShuffle.addEventListener('click', onShuffleTopic);
        el.btnTopic.addEventListener('click', openTopicDialog);
        el.segs.forEach(b => b.addEventListener('click', () => onSelectCategory(b.dataset.cat)));
        $$('#topicSeg .segCat').forEach(b => b.addEventListener('click', () => setDialogCategory(b.dataset.cat)));

        window.addEventListener('keydown', (e) => {
          if (!state.started) {
            if (e.key === ' ' || e.key === 'Enter') { e.preventDefault(); onStart(); }
            return;
          }
          if (e.ctrlKey && (e.key === 'r' || e.key === 'R')) { e.preventDefault(); onReset(); }
          if (!state.category) return;
          if (e.key === ' ' || e.key === 'Enter') { e.preventDefault(); onDraw(); }
          if (e.key === 's' || e.key === 'S') { e.preventDefault(); onShuffleTopic(); }
          if (e.key === 't' || e.key === 'T') { e.preventDefault(); openTopicDialog(); }
        });
        render();
      }

      function resetPool(){
        state.pool = Array.from({length: state.max}, (_,i)=> i+1);
        state.drawn = [];
        el.overlayNumber.textContent = '–';
      }

      // ===== フロー =====
      function onStart(){
        if (state.started) return;
        state.started = true;
        document.body.classList.add('mode-normal'); // 仮に通常カラー
        el.progress.textContent = 'カテゴリを選択してください';
      }

      function onSelectCategory(cat){
        if (!state.started) return;
        state.category = cat;
        applyCategoryTheme(cat);
        // 既定お題
        const list = state.topicsByCategory[cat] || [];
        state.topic = list[0] || null;
        setEnabled([el.btnDraw, el.btnShuffle, el.btnTopic], true);
        el.catPill.style.display = '';
        render();
      }

      // ===== お題選択ダイアログ =====
      const dlg = { category: null };
      function openTopicDialog(){
        if (!state.category) return;
        dlg.category = state.category;
        updateDialogSeg();
        buildTopicListFor(dlg.category, state.topic);
        el.topicDialog.showModal();
      }
      function setDialogCategory(cat){
        dlg.category = cat; updateDialogSeg(); buildTopicListFor(cat, null);
      }
      function updateDialogSeg(){
        $$('#topicSeg .segCat').forEach(b => b.setAttribute('aria-pressed', String(b.dataset.cat === dlg.category)));
      }
      el.topicDialog?.addEventListener('close', () => {
        if (el.topicDialog.returnValue === 'ok') {
          const selected = document.querySelector('#topicList input[type=radio]:checked');
          if (dlg.category) state.category = dlg.category;
          applyCategoryTheme(state.category);
          if (selected) state.topic = selected.value;
          setEnabled([el.btnDraw, el.btnShuffle, el.btnTopic], true);
          el.catPill.style.display = '';
          render();
        }
      });

      // ===== アクション =====
      function onShuffleTopic(){
        if (!state.category) return;
        const list = state.topicsByCategory[state.category] || [];
        if (!list.length) return;
        const others = list.filter(t => t !== state.topic);
        state.topic = (others[Math.floor(Math.random() * others.length)]) || list[0];
        // 軽いフィードバック
        el.topicText.style.transition = 'transform .1s';
        el.topicText.style.transform = 'scale(1.06)'; setTimeout(()=> el.topicText.style.transform = 'scale(1)', 120);
        render();
      }
      function onDraw(){
        if (!state.category || state.pool.length === 0) return;
        const idx = Math.floor(Math.random() * state.pool.length);
        const value = state.pool.splice(idx, 1)[0];
        state.drawn.unshift(value);
        el.overlayNumber.textContent = value;
        el.overlayNumber.classList.remove('bump'); void el.overlayNumber.offsetWidth; el.overlayNumber.classList.add('bump');
        render();
      }
      function onReset(){
        if (!confirm('すべて初期化して最初からやり直しますか？')) return;
        document.body.classList.remove('mode-normal','mode-rainbow','mode-classic');
        state.started = false; state.category = null; state.topic = null; resetPool();
        setEnabled([el.btnDraw, el.btnShuffle, el.btnTopic], false);
        el.catPill.style.display = 'none';
        render();
      }

      // ===== 補助 =====
      function setEnabled(elems, enabled){ elems.forEach(x => x.disabled = !enabled); }
      function applyCategoryTheme(cat){
        document.body.classList.remove('mode-normal','mode-rainbow','mode-classic');
        if (cat) document.body.classList.add('mode-' + cat);
      }
      function buildTopicListFor(cat, current){
        const list = state.topicsByCategory[cat] || [];
        el.topicList.innerHTML = list.map((t,i)=> `
          <label class="topic-item">
            <input type="radio" name="topic" value="${t}" ${current ? (t===current?'checked':'') : (i===0?'checked':'')} />
            <span>${t}</span>
          </label>
        `).join('');
      }
      function labelFor(cat){ return cat==='normal'?'通常':cat==='rainbow'?'レインボー':cat==='classic'?'クラシック':'—'; }

      function render(){
        if (!state.started) {
          el.progress.textContent = '未開始';
        } else if (!state.category) {
          el.progress.textContent = 'カテゴリを選択してください';
        } else {
          el.progress.textContent = `${state.drawn.length} / ${state.max} （残り ${state.pool.length}）`;
        }
        if (state.category) {
          el.catPill.textContent = `カテゴリ: ${labelFor(state.category)}`;
        }
        el.topicText.textContent = state.topic ?? '（未選択）';
        el.history.innerHTML = state.drawn.slice(0, 12).map(n => `<span class="chip">${n}</span>`).join('');
        el.btnDraw.textContent = state.pool.length ? '数字を選ぶ' : '完了';
      }

      init();
    </script>
  </body>
  </html>

