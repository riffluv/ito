依頼のゴール

観戦モードの設計を「単純・安定・拡張可能」に再構築（Spectator Mode V3）。
現状の「途中成果＋空きスロット修正」をベースに、観戦UIの揺れ・再入室時の不整合・ゲーム中入席の可能性を解消。
将来のチケット制・承認制・観戦者一覧などへ安全に拡張できる骨格を作る。
現在地（重要ポイント）

空きスロット問題は解消済み（presence から観戦者を除外してカウント）。修正核: lib/game/selectors.ts (line 112) と app/rooms/[roomId]/page.tsx (line 2549) 近辺。
観戦UIは改善したが、再入室や状態遷移のタイミングで「一瞬出て消える」「2回目以降で出ない」揺れが残る。
原因候補: sessionStorage の pendingRejoin:* フラグ残存、seatRequestState(pending) の残留、複数フラグ（joinStatus/optimisticMe/presence/forcedExit など）の相互作用。
一部プロトタイプ的な変更が入っているので、V3 でシンプル化・一本化を行う。
非機能要件

互換性保持のため feature flag で切替（デフォルト OFF → 変更は NEXT_PUBLIC_SPECTATOR_V3=1 時のみ有効）。
既存の空きスロット修正は常時維持。
デプロイ不要。ローカルで動作確認できること。
用語と最小仕様

観戦者: rooms/{roomId}/players に自分のドキュメントが存在しないユーザー。
入席可否はサーバ（Firestore ドキュメント状態）で一意に制御し、クライアントの複雑な推測ロジックを排除。
リセット時のみ観戦者の「席に戻る」を許可。ゲーム中（clue/reveal/finished～次ゲーム）では不可。
データモデル（追加／整理）

rooms/{roomId}.ui.recallOpen: boolean
true: 席へ戻る許可（Reset 後の waiting だけ true）。
false: それ以外すべて（ゲーム中・次のゲーム準備中等）。
rooms/{roomId}/rejoinRequests/{uid}: { status: "pending"|"accepted"|"rejected", displayName?: string|null, createdAt }
TTL かクライアント側の明示クリアで自然消滅（長期残留禁止）。
サーバ側ガード（最小）

lib/services/roomService.ts (line 108) ensureMember 内で、入席可否をチェック:
room.status !== "waiting" → ROOM_IN_PROGRESS（入席拒否）
room.status === "waiting" && ui.recallOpen !== true → ROOM_IN_PROGRESS（入席拒否）
上記以外のみ players へ新規作成可
既存実装の強化方針で可（Cloud Functions 化は任意だが推奨。今回範囲外）。
クライアント側の簡素化（V3 仕様）

観戦UI表示判定は「players に自分がいない」のみ。presence/joinStatus/optimisticMe で判定しない。
観戦UIは常に固定枠で描画し、内容だけ状態に応じて切替（消したり出したりしない）。
「席に戻る」ボタンは recallOpen が true の時だけ活性（それ以外は常に非活性＋説明文言）。
sessionStorage の pendingRejoin:* は使用禁止。意図の持ち越しは rejoinRequests に一本化。
観戦遷移時に残留状態の初期化を必ず実行（seatRequestState/pending/timedOut/optimisticMe/leavingRef クリア）。
UIステート（観戦バナーの中身）

version-mismatch
mid-game（= ゲーム進行中）: 「ラウンド終了後に席に戻れます」ボタンは disabled
waiting-closed（waiting だが recallOpen=false）: 同上
waiting-open（waiting かつ recallOpen=true）: 「席に戻る」active, pending/accepted/rejected 表示
Host 側の制御

「次のゲーム」= recallOpen=false を確実にセット（既存の useHostActions.ts (line 347) 前後の restart フロー内）。
「リセット」= recallOpen=true をセット（lib/firebase/rooms.ts (line 290) の resetRoomWithPrune ですでに拡張済み項目あり。最終仕様に合わせて調整）。
必要ならホスト UI に recallOpen のトグルを後付け可能（今回は自動切替でOK）。
タスク一覧（V3 実装）

フラグとゲートの導入
rooms.ui.recallOpen を本番運用フラグとして採用。
Host 操作でのセット:
次のゲーム → false（lib/hooks/useHostActions.ts (line 347) 以降の restart 内）
リセット → true（lib/firebase/rooms.ts (line 290) の resetRoomWithPrune 内）
ensureMember の入席ゲートを recallOpen と waiting に基づいて強化（lib/services/roomService.ts (line 108) 以降）
観戦UIの出現条件の単純化（feature flag で切替）
app/rooms/[roomId]/page.tsx (line 135) 付近（function RoomPageContent 開始）で V3 分岐:
isSpectator = !players.some(p => p.id === uid) のみで判定
観戦UIを常に描画し、state 文言のみ切替
pendingRejoin 系の sessionStorage 読書きを無効化（useRoomState.ts (line 54) と app/rooms/[roomId]/page.tsx (line 1045) 付近の setPendingRejoinFlag 呼び出し）は V3 条件下では通さない
観戦遷移時の初期化を厳密化（seatRequestState/timedOut/leavingRef/optimisticMe クリア）
席に戻るのガード
観戦UIの「席に戻る」クリックは、recallOpen && room.status === "waiting" のときだけ rejoinRequests を作成。
それ以外の状態ではクリックしても pending を作らない（UI は disabled）
既存 rejoinRequests の subscribe は維持し、accepted のときのみ join 実行
既存の空きスロット修正は維持（変更不可）
lib/game/selectors.ts (line 112) の playerIds フィルタ
app/rooms/[roomId]/page.tsx (line 2549) 近辺の呼び出し（playerIds 付与）
トレース／ログ最小セット
観戦遷移時: traceAction("spectator.enter", { roomId, uid, reason })
入席拒否: traceAction("join.blocked", { roomId, uid, status, recallOpen })
席に戻る要求: traceAction("spectator.requestSeat", { roomId, uid })
Feature Flag
.env.local に NEXT_PUBLIC_SPECTATOR_V3=1
V3 が ON のときだけ上記の簡素ロジックを適用。OFF では現行動作を保持。
受け入れ基準（Acceptance Criteria）

mid-game に URL で入室 → 観戦UIが安定表示され続ける（チラつき無し・プレイヤー欄に出ない）。
退出→同じタブで再入室（連続3回以上）→ 毎回観戦UIが表示される。
観戦UIの「席に戻る」は mid-game／waiting-closed では常に disabled。waiting-open でのみ作動。
リセット時（waiting-open）→ 観戦UIから「席に戻る」→ キューが作成されホスト承認で入席できる。
次のゲーム（waiting-closed）→ 同観戦者は入席不可（disabled のまま）。
空きスロット数はプレイヤー数に一致（観戦者で増えない）。
テスト（推奨）

Playwright シナリオを追加（既存 tests/presence-host.spec.ts に倣う）
mid-game 入室 → 観戦UI安定
再入室 3 回繰返し → 観戦UI安定
waiting-open と waiting-closed の「席に戻る」活性/非活性確認
承認 → 入席／拒否 → 観戦継続
単体テスト
computeSlotCount は既存＋観戦者除外ケース（tests/selectors.spec.ts）を維持
変更対象ファイル（主要）

観戦 UI と判定: app/rooms/[roomId]/page.tsx (line 135)
ルーム状態: lib/hooks/useRoomState.ts (line 54)
参加者集約: lib/hooks/useParticipants.ts (line 51)
サーバ側ゲート: lib/services/roomService.ts (line 108)
リセット/次ゲームの制御: lib/hooks/useHostActions.ts (line 61), lib/firebase/rooms.ts (line 290)
スロット数計算: lib/game/selectors.ts (line 112)
実装順序（推奨）

フラグ NEXT_PUBLIC_SPECTATOR_V3 追加 → V3 分岐だけ先に入れて build 通す
recallOpen 導入＆ Host 操作からのセット → ensureMember のゲート完成
観戦UIの常時描画＋簡素判定へ移行 → sessionStorage/optimistic 系の観戦判定からの撤退
席に戻るの無効化ロジックと rejoinRequests の一本化
E2E シナリオで回帰確認
留意点／落とし穴

presence は UI 補助（ラベル/一覧）に限定し、観戦判定に使わない。チラつきの原因になる。
sessionStorage は V3 で廃止（観戦復帰意図はリクエストドキュメントに一本化）。
rejoinRequests は TTL/クリーンアップ必須。pending のまま残らないように。
旧コードの optimisticMe は join 完了や seat 承認の瞬間だけで使う（観戦判定には使わない）。
引継ぎ補足

現状は「空きスロット修正」と「観戦安定化の途中成果」が混在。V3 実装は feature flag 下で進め、flag OFF では現状維持できるようにしておくと安全です。
ドキュメント更新先: docs/OPERATIONS.md に観戦V3のフロー（UI/サーバ/ホスト操作）を追記してください。
以上を満たす形で、Spectator Mode V3 の実装・最小テストまでお願いします。必要あれば「Cloud Functions 化（joinSeat/leaveSeat）」タスクを後工程に残し、今回は ensureMember のゲート強化で完了として構いません。