● # ホスト権限管理の完全な修正依頼

  ## 🚨 緊急度: CRITICAL

  ホスト権限が非常に不安定で、開発が進められません。
  Firebaseのベストプラクティスに従った、確実に動作する実装をお願いします。

  ---

  ## 📋 現在の症状

  ### 症状まとめ
  1. **部屋作成直後**: ホスト権限がもらえないことが多い（不安定）
  2. **リフレッシュ（F5）**: ホスト権限が失われる
  3. **ハードリフレッシュ（Ctrl+Shift+R）**: ほぼ確実にホスト権限が失われる
  4. **唯一安定するケース**: 一度ロビーに戻って、再入室した1回目

  ### 重要な事実
  - ✅ **Vercel本番環境では安定している**
  - ❌ **開発環境（localhost）だけで問題が発生**
  - ❌ **2人でテストすると2人目がログインしてきた時にホストが移ることがある**

  ### 再現手順
  1. localhost:3000 で部屋を作成
  2. 「へやへ すすむ」で入室
  3. ❌ ホスト権限がもらえないことが多い
  4. ロビーに戻る
  5. 同じ部屋に再入室
  6. ✅ この時だけ安定してホスト権限がもらえる
  7. ブラウザをリフレッシュ（F5）
  8. ❌ ホスト権限が失われる
  9. ハードリフレッシュ（Ctrl+Shift+R）
  10. ❌ ほぼ確実にホスト権限が失われる

  ---

  ## 🔍 技術情報

  ### プロジェクト構成
  - **フレームワーク**: Next.js 14 (App Router)
  - **データベース**: Firebase Firestore
  - **認証**: Firebase Anonymous Auth
  - **環境**: 開発環境とVercel本番環境で同じFirestoreを共有

  ### 関連ファイル

  #### クライアント側
  lib/hooks/useHostClaim.ts          ← ホストクレームロジック
  lib/hooks/useRoomState.ts          ← isHost の計算
  app/rooms/[roomId]/page.tsx        ← メインページ

  #### サーバー側
  app/api/rooms/[roomId]/claim-host/route.ts  ← API
  lib/server/roomActions.ts                   ← ensureHostAssignedServer
  lib/host/HostManager.ts                     ← ホスト割り当てロジック

  #### その他
  lib/firebase/client.ts             ← Firestore設定
  firestore.rules                    ← Security Rules
  components/CreateRoomModal.tsx     ← 部屋作成UI

  ### データモデル
  ```typescript
  // Firestore: rooms/{roomId}
  {
    hostId: string,        // ホストのUID（必須、空文字不可）
    hostName: string,
    creatorId: string,
    status: "waiting" | "clue" | "reveal" | "finished",
    // ... その他
  }

  // Firestore: rooms/{roomId}/players/{uid}
  {
    uid: string,
    name: string,
    // ... その他
  }

  Firestore Security Rules の制約

  // hostId は必須で、空文字は許可されない
  && (!('hostId' in data) || (data.hostId is string && data.hostId.size() > 0))

  // 部屋作成時、hostId は作成者のUIDでなければならない
  allow create: if isAuthenticated()
    && request.auth.uid == request.resource.data.hostId

  ---
  💡 推測される原因

  1. 開発環境とVercelの競合

  - 開発環境とVercel本番環境が同じFirestoreを共有している
  - 開発中にVercelのタブが開いていると、ホスト権限が競合する
  - 先に接続した方がホストになり、後から接続した方は弾かれる

  2. Firestoreキャッシュの問題

  - persistentSingleTabManager が開発時に古いデータを返す
  - HMR (Hot Module Replacement) でキャッシュが不安定になる
  - リフレッシュ時にキャッシュがクリアされて、ホスト情報が消える

  3. 複雑すぎるホストクレームロジック

  - useHostClaim の条件が複雑すぎて、予期しない動作をしている
  - タイミング問題: Firebase Auth復元とFirestore同期のタイミングがずれる

  ---
  🎯 解決してほしいこと

  必須要件

  1. ✅ 部屋作成直後に100%ホスト権限が付与される
  2. ✅ リフレッシュ（F5）後もホスト権限が維持される
  3. ✅ ハードリフレッシュ（Ctrl+Shift+R）後もホスト権限が維持される
  4. ✅ 複数人でテストしても、正しい人がホストになる
  5. ✅ 開発環境でも本番環境と同じように安定動作する

  実装のお願い

  1. Firebaseのベストプラクティスに従った実装

  - 公式ドキュメントやベストプラクティスを参照してください
  - シンプルで信頼性の高い設計にしてください
  - 以下を参考にしてください：
    - Firebase公式: Multiplayer game hosting patterns
    - Firestore Best Practices
    - Real-time synchronization patterns

  2. 開発環境での安定化

  - 開発環境特有の問題（HMR、キャッシュ）に対応してください
  - 必要であれば、開発時のみキャッシュを無効化する等の対応を

  3. ホスト権限の明確なルール

  以下のルールを確実に実装してください：

  ホスト決定ルール:
  1. 部屋作成者が最初のホスト（必須）
  2. ホストが退室したら、次の候補にホストを譲渡
    - 候補の優先順位: オンライン > 入室順
  3. リフレッシュしても、元のホストが維持される
  4. 2人目がログインしてきても、元のホストが維持される

  ---
  🔧 参考: 試した修正（すべて失敗）

  以下の修正を試しましたが、すべて失敗しました。参考にしてください。

  試した修正1: Firestore永続化設定

  - persistentSingleTabManager ↔ persistentMultiTabManager
  - 開発環境のみキャッシュ無効化
  - 結果: 効果なし

  試した修正2: useHostClaim の条件修正

  - isRecoveringHost の条件を緩和
  - 早期リターン条件の見直し
  - 結果: 効果なし

  試した修正3: HostManager.evaluateClaim 修正

  - クレーム者が現在のホストと同じ場合の処理
  - 結果: 効果なし

  試した修正4: useRoomState の依存配列修正

  - [room?.hostId, uid] → [room, uid]
  - 結果: 効果なし

  試した修正5: useHostClaim の完全無効化

  - ホストクレームを無効化し、Firestoreの hostId だけを信頼
  - 結果: 効果なし

  ---
  📝 重要な注意事項

  現在のコード状態

  - 最新のコミット以前の安定版に戻しました
  - これから修正する際は、クリーンな状態からスタートできます

  テスト方法

  開発環境でのテストは以下の手順で：
  1. Vercelのタブを全て閉じる（重要）
  2. 開発サーバーを起動: npm run dev
  3. ブラウザでテスト
  4. リフレッシュ、ハードリフレッシュで確認

  期待される実装

  - シンプル: 複雑なロジックは避ける
  - 信頼性: Firestoreのトランザクションを正しく使う
  - ベストプラクティス: Firebaseの推奨パターンに従う

  ---
  ✅ 完了条件

  以下がすべて達成されたら完了です：

  1. ✅ 部屋作成直後に100%ホスト権限が付与される
  2. ✅ リフレッシュ（F5）後もホスト権限が維持される
  3. ✅ ハードリフレッシュ（Ctrl+Shift+R）後もホスト権限が維持される
  4. ✅ 2人でテストしても、作成者がホストとして維持される
  5. ✅ 10回連続でリフレッシュしても安定動作する
  6. ✅ コンソールにエラーが出ない
  7. ✅ Vercel本番環境でも正常動作する

  ---
  🙏 お願い

  Firebaseのベストプラクティスに従って、確実に動作するホスト権限管理を実装してください。

  現在のコードは複雑すぎて、何度修正しても問題が解決しません。
  必要であれば、ホスト権限管理の仕組み全体を再設計してください。
