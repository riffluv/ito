# Codex様への依頼: カードリセット時の連想ワードちらつき問題

## 🚨 問題の詳細

### 発生タイミング
- ゲーム中に**「リセット」または「もう一度」ボタン**を押した時
- カードが**自分の手札エリア（下部のwaitingエリア）に戻ってくる**瞬間

### 現象
1. プレイヤーが連想ワードを提出済み（例: 「りんご」）
2. リセットボタンを押す
3. カードが下のwaitingエリアに戻ってくる
4. **戻った瞬間、カード内のテキストが「りんご」→「waiting」に切り替わるのが一瞬見える**
5. この**ちらつき**が非常に気になる

### 重要な制約
- **現在のレスポンス速度は極限まで最適化済み**
- この**レスポンス速度を破壊してはいけない**（最重要）
- 単純な遅延追加などはNG

## 🔍 試した解決策（失敗）

### Claude（私）が試したこと

#### 1. GameCard.tsxのflip時opacity制御（失敗）
- **問題**: 回転アニメーション時の対策をしてしまった
- **原因**: 問題を誤解していた（回転ではなく移動時の問題）

#### 2. logic.tsでwaitingステータス時にclueText = null（失敗）
- **修正箇所**: `lib/cards/logic.ts:171-177`
- **内容**: `roomStatus === "waiting"`の時に`clueText`を`null`にした
- **結果**: 効果なし、依然としてちらつく

```typescript
// 修正内容（効果なし）
const clueText =
  p.roomStatus === "waiting"
    ? null
    : p.roomStatus !== "finished"
      ? clue1 || "(連想待ち)"
      : clue1 || null;
```

## 💡 推測される原因

### 考えられるシナリオ
1. **レンダリングタイミング問題**
   - Reactの状態更新が非同期で、カード移動アニメーションと連想ワード削除が微妙にズレている
   - DOMの更新順序の問題

2. **Firestore同期タイミング**
   - リセット処理でFirestoreの`player.clue1`をクリアしているが
   - クライアント側のローカル状態と同期が遅れている

3. **カードコンポーネントのメモ化**
   - `GameCard`が`memo`化されていて（GameCard.tsx:421-436）
   - propsの更新検知が遅れている可能性

4. **CSS transition/animation**
   - カード移動のアニメーション中に内部テキストが更新されている
   - `willChange`や`transform`による最適化の副作用

## 📂 関連ファイル

### 主要ファイル
1. **`components/ui/GameCard.tsx`**
   - カードコンポーネント本体
   - memoization実装あり（421-436行目）

2. **`lib/cards/logic.ts`**
   - `computeCardState()`: カードの状態計算
   - `clueText`の決定ロジック（171-177行目）

3. **`components/ui/cardViewModel.ts`**
   - `createBoardCardViewModel()`: ボードカード用
   - `createWaitingCardViewModel()`: waitingエリア用（60-76行目）

4. **`components/hooks/useHostActions.ts`**
   - リセット/もう一度ボタンのハンドラー

5. **`components/ui/CardFaces.tsx`**
   - カードの表面・裏面レンダリング
   - `clue || "(連想なし)"`の表示（190行目）

### リセット処理関連
- リセットボタンの実装箇所を特定する必要あり
- `player.clue1`をクリアする処理

## 🎯 期待する解決方法

### ゴール
- カードがwaitingエリアに戻る時、**連想ワードが絶対に見えないようにする**
- **現在のレスポンス速度を維持**（これが最重要）

### アプローチの方向性（推測）
1. **テキスト更新のタイミング制御**
   - カードアニメーション開始前にテキストをクリア

2. **opacity/visibility制御**
   - 連想ワード部分だけを即座に非表示

3. **レンダリング最適化**
   - `useMemo`/`useCallback`の見直し
   - 不要な再レンダリングの削除

4. **状態管理の改善**
   - ローカル状態とFirestore同期の最適化

## 📝 備考

- この問題はClaude（私）では解決できなかった
- Codex大先生の別視点からのアプローチが必要
- ユーザーは「極限まで上げてるレスポンス」を非常に重視している

---

**Codex様、この難題の解決をお願いします！🙏**
