# Pixi ベースカード実装指示書

## ゴール
既存の `GameCard` ビジュアルを Pixi.js ベースへ段階的に移行し、レスポンスを損なわずに “実機感” を持たせる。ゲームロジック・操作感（ドラッグ＆ドロップ、フリップ、並び替え、公開アニメーション等）は一切変更しない。初期スキンは黒ベースで質感重視、将来的にスキン販売へ拡張可能な設計とする。

## スコープ
- 対象: 盤面中央に表示される主要サイズの `GameCard`（待機エリア／盤面上／公開フリップ／リザルトで共有されるカード概念）。
- 段階導入: 初期リリースでは盤面中央カードのみ Pixi 化。他領域は DOM レンダーを維持し、段階的に拡張予定。
- 非対象: ゲームルール、ネットワーク、サーバロジックの変更。開始テンポを阻害する長尺演出、常時処理が重いフィルタ（bloom, godray 等）。

## 全体方針
1. **レンダラー抽象化**  
   - `GameCard` 直下に `renderer: 'dom' | 'pixi'` を受け取る層を新設。初期値は `pixi`。フラグで DOM 版へ切替可（A/B やフォールバック用途）。
   - `renderer === 'dom'` 時は既存の見た目・挙動が完全一致することを必須条件とする。
2. **Pixi レイヤの差し込み**  
   - DOM 側 3D フリップ構造（CSS transform＋GSAP タイムライン）を維持しつつ、表面のビジュアルのみ `PIXI.Container` 内へ差し替える。Canvas を包むラッパーを既存 DOM ツリーに挿入し、タイムラインから参照される DOM 構造は壊さない。
   - 既存のヒットボックス・ポインターイベント（D&D、クリック、キーボードフォーカス）は DOM で処理。Pixi は見た目専用。`pointer-events: none` のキャプチャ設定を確認し、既存のイベント委譲が継続するようにする。
3. **SSR/CSR 安全性**  
   - Pixi 初期化は `useEffect` 内でクライアント限定。初期描画は DOM レンダーを仮置き→ Pixi 初期化完了後に差し替え。初期化失敗時は自動で DOM レンダーへ戻す。
   - エラー発生時はログ（console + 任意の監視フック）を出し、ユーザー体験を阻害せず継続させる。
4. **品質トグルの導入**  
   - `renderer` に加え `quality: 'high' | 'low'`（初期値 `high`）を受け付ける。低品質時は重いエフェクト（ライト走査、箔）を OFF。
   - URL クエリやルーム設定で上書きできる仕組みを用意（例: `?cardRenderer=pixi&cardQuality=low`）。最低限、実装テスト段階で props か context から切替できれば良い。

## Pixi スキン要件（初期黒ベース）
1. **ベースカラー**  
   - 黒ベース（#080B11 前後）＋縦方向グラデーション（上: #1A1E28, 下: #05070A）。
2. **エッジ表現**  
   - 内側ハイライト（薄いシアン寄り）、外周シャドウをレイヤーで表現。角は軽く丸める（既存 DOM と同程度）。
3. **質感レイヤ**  
   - 微ノイズ（α 0.06–0.1）を常時オーバーレイ。RenderTexture で再利用し、各カードで共有。
   - ライト走査（成功時やホバー時のみ発火、1.0–1.2s、SCREEN ブレンド）。既定では非ループ。イベント受信で開始する API を用意。
   - 微揺れ（±2–3°、1.8–2.4s、sine in-out）。`quality='low'` 時は停止可能に。
4. **文字・数字レンダ**  
   - 既存の番号／テキストを BitmapText または SDF（MSDF-BMFont 等）でレンダリングし、スケールしても鮮明に保つ。動的語彙が多い場合は RenderTexture に一度焼き込む。
5. **レイヤー構造**  
   - `frame`（縁取り）, `base`（グラデ基礎）, `art`（将来スキン差替用）, `text`, `foil`（任意） , `grain` のレイヤーを想定。将来スキン追加時に差し替えられるようモジュール化。

## パフォーマンス要件
- **主要アクションの描画コスト ≤ 4ms/フレーム**  
  - Pixi Ticker で `deltaMS` を取得し、4ms 超えを検知したら一時的にエフェクトを落とす（ライト走査キャンセル等）。
- **共有テクスチャ再利用**  
  - ノイズ、ハイライト、シャドウ等はシングルトンで生成し、全カードで共有。`cacheAsBitmap` / `RenderTexture` を適宜活用（ただしアニメーション中は `cacheAsBitmap` OFF に注意）。
- **フィルタ常時 ON 禁止**  
  - ブラーやカラーシェーダーはイベント時のみ ON/OFF。デフォルトは全体でフィルタ 0。
- **GC/メモリ対策**  
  - Pixi コンテナ破棄時は `destroy({ children: true, texture: false, baseTexture: false })` などでリソース管理。React アンマウント時に確実にクリーンアップ。

## フラグ設計
- `renderer`: `'dom' | 'pixi'`（デフォルト `'pixi'`）。SSR 初期レンダリングでは `'dom'` を強制→Pixi 初期化後に `'pixi'` へ切替。
- `quality`: `'high' | 'low'`（デフォルト `'high'`）。`low` 時は以下を OFF:
  - ライト走査アニメーション
  - 微揺れ
  - 高解像ノイズのフルサイズ表示（縮小・縮退版を使用）

## GSAP / アニメーション連携
- 既存の GSAP タイムライン（フリップ、配置アニメ等）が `rotation` / `scale` / `alpha` を操作できるよう、Pixi コンテナ（または包む DOM ラッパー）への参照を `forwardRef` 等で渡す。
- 3D フリップ（CSS transform）は DOM ラッパーで継続、Canvas 自体を表裏に貼る構造とし、Z 軸回転に追随させる。
- Pixi 内部アニメーションは `gsap.ticker` OR Pixi Ticker に統合し、`requestAnimationFrame` を二重に回さないよう注意。

## 実装ステップ案（推奨）
1. **抽象化レイヤ追加**  
   - `GameCardView`（仮）コンポーネントを作り、`renderer` フラグで DOM / Pixi を切替。既存 DOM 版はそのまま移植。
2. **Pixi ラッパー骨格実装**  
   - `useEffect` で Pixi Application（または `PIXI.Renderer` + `PIXI.Container`）を初期化し、Canvas を DOM ラッパーに挿入。初期描画は黒ベースの静的カードで OK。
3. **エフェクトレイヤ実装**  
   - ノイズ、ハイライト、シャドウ、ライト走査、微揺れを順に導入。各エフェクトは独立したクラス/Hook に分割し、品質トグルで制御。
4. **文字レンダリング差し替え**  
   - 既存番号／テキスト表示を Pixi 版へ移行。フォントアセットの読み込み・キャッシュを実装。
5. **フォールバックとエラー処理**  
   - Pixi 初期化失敗時に DOM レンダーへ戻す処理を追加。エラーログを監視に送る仕組みを用意。
6. **A/B 切替導線**  
   - `renderer` / `quality` を URL パラメータ・ルーム設定で上書きするルールを実装。少なくともクライアント側で簡易スイッチができるようにする。
7. **パフォーマンス計測**  
   - Pixi Ticker で `deltaMS` をログ出力（dev ビルドのみ）し、主要アクション（ドラッグ、提出、公開）のフレームコストを確認。予想以上の負荷が出た場合は品質を自動で落とす処理を検討。
8. **手動テスト**  
   - DOM 版／Pixi 版で以下を比較: D&D、クリック、キーボード操作、フリップ演出、公開シーケンス。挙動／体感タイミングが一致しているか確認。

## 監視・計測ポイント
- `performance.now()` を用いたドラッグ中の描画時間計測（目標 ≤4ms）。
- Pixi Ticker で `deltaMS` の最大値・平均値を収集（dev 用コンソールログまたは計測ツール）。
- Pixi 初期化成功率（失敗時は DOM フォールバック＋ログ）。
- A/B テスト時の TTFS（初回入力まで時間）とラウンド継続率の差分（±1〜2% 以内を目安）。

## 提出時チェックリスト
- `renderer='dom'` で現行と完全一致することを確認。
- `renderer='pixi'` で黒ベースの質感（グラデ、ハイライト、ノイズ、ライト走査トリガ、微揺れ）が動作。
- `quality='low'` でライト走査／微揺れが止まり、60fps を維持できるか実機確認。
- Pixi 初期化失敗時に自動フォールバックしてゲーム続行が可能か確認。
- ドラッグ・提出・公開など主要操作で描画コスト ≤4ms/フレームを計測。

## 補足メモ
- 将来スキン販売を見据え、`GameCardSkin` のようなデータ構造を用意してカラーパレットやテクスチャセットを差し替えられる設計が望ましい。初期スキンは「Black Default」として実装。
- ライト走査や箔エフェクトのトリガ（成功時、ホバー時等）は既存イベントフローに合わせて `props`/`context` で受け取り、エフェクト開始 API を提供。GSAP タイムラインから呼び出すように設計する。
- モバイル端末では Canvas サイズや解像度を適宜ダウンサンプルし、解像度と負荷のバランスをとる。

---

この指示書に従えば、Pixi ベースへの移行をレスポンスを保ったまま安全に実施でき、将来のスキン拡張にも対応しやすくなる。追加の制約や A/B 条件が出た場合はこのドキュメントに追記して運用すること。*** End Patch*** End Patch
