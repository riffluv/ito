# ゲーム進行ロジック総点検依頼ガイド

次回 Codex にレビューを依頼する際は、作業範囲が広いため、以下の指示文をそのまま渡してください。

---

## 指示文

このセッションでは、ゲーム進行ロジック（.firestore トランザクション、差分同期、ホスト交代処理を含む）に関する本格的なコードレビューをお願いします。進行不能バグや過負荷のリスクを洗い出すため、下記ステップで段階的に確認してください。

1. **範囲の確定**  
   - `lib/game/room.ts`、`lib/services/roomService.ts`、`lib/hooks/useOptimizedRoomState.ts` を中心に、ゲーム状態の読取・書込ロジックをすべて洗い出してください。  
   - Firestore トランザクションを使用する箇所（土台となる `runTransaction` 呼び出し）を一覧化し、重複や例外処理漏れがないか確認してください。

2. **差分同期（クライアント側）**  
   - `useOptimizedRoomState` / `useParticipants` の購読・デバウンス挙動を精査し、Race Condition や stale data の懸念を指摘してください。  
   - 画面表示（`CentralCardBoard.tsx`、`MiniHandDock.tsx` など）に渡されるデータが、最新状態とズレる可能性があるか確認してください。

3. **ホスト関連の動作**  
   - `lib/host/HostManager.ts`、`useHostClaim`、`useHostActions` を中心に、ホスト交代の境界ケース（ホスト切断・即時復帰・複数タブ）に問題がないか検証してください。  
   - `transferHost` を含む Firestore 更新の整合性とリトライ戦略を確認してください。

4. **負荷・ボトルネック評価**  
   - `topicControls`、`dealNumbers` など、ゲーム開始時に集中する処理の負荷ポイントを洗い出し、キャッシュやバッチ化が必要な箇所を提案してください。  
   - 高頻度で実行される処理（通知、ログ記録、リアルタイム更新）について、実測または推計ベースでボトルネック候補を指摘してください。

5. **優先度づけと改善提案**  
   - 見つかった懸念点を重大度順に整理し、改善案（コード修正・リファクタ案・テスト追加案）を簡潔にまとめてください。  
   - 改善コストが高いものは、段階的な実施計画に落とし込んで提示してください。

レビュー結果は箇条書きで構いません。再現手順やソースファイルの箇所（行番号）を明示のうえ報告してください。

--- 

この指示文に沿ってもらえれば、進行不能バグや負荷要因の洗い出しが段階的に進みます。必要に応じて、このガイドを更新して構いません。
