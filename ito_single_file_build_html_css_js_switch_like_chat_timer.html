<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>ITO â€“ Party Build (Single File)</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet"/>
<style>
  /* ---------------- TOKENS / RESET ---------------- */
  *,*::before,*::after{box-sizing:border-box}
  html,body{block-size:100%;}
  :root{
    --bg0:#0e1525; --bg1:#141b2d; --bg2:#1a2238; --panel:rgba(255,255,255,.06);
    --line:rgba(255,255,255,.12); --text:#fff; --muted:#b8c0d4;
    --primary:#ff6b35; --secondary:#4ecdc4; --accent:#ffe66d; --blue:#4a90e2;
    --r-lg:20px; --r-md:14px; --shadow:0 20px 40px rgba(0,0,0,.35);
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-right: env(safe-area-inset-right, 0px);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
    --safe-left: env(safe-area-inset-left, 0px);
  }
  body{ margin:0; color:var(--text); font-family:'Noto Sans JP',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    min-block-size:100svh; background:
      radial-gradient(1100px 520px at 10% 80%, rgba(255,107,53,.12), transparent 60%),
      radial-gradient(1100px 520px at 90% 10%, rgba(78,205,196,.12), transparent 60%),
      linear-gradient(135deg, var(--bg1), var(--bg2));
    overflow:clip; }
  @supports(min-height:100dvh){ body{ min-block-size:100dvh; } }

  .app{ block-size:100%; max-inline-size:1440px; margin-inline:auto; padding:16px; padding-top:calc(16px + var(--safe-top)); padding-bottom:calc(16px + var(--safe-bottom));
    display:grid; gap:16px; grid-template-areas:
      "header header header"
      "players main chat"
      "board   board chat"
      "hand    hand  chat";
    grid-template-columns: 18rem minmax(0,1fr) 22rem; grid-template-rows: auto minmax(0,1fr) minmax(0,1fr) auto; }

  .surface{ background:var(--panel); border:1px solid var(--line); backdrop-filter:blur(14px); border-radius:var(--r-lg); box-shadow:var(--shadow); min-block-size:0; }
  button{ font:inherit; color:#fff; background:linear-gradient(135deg,var(--primary),#ff8a50); border:0; border-radius:12px; padding:10px 14px; cursor:pointer; box-shadow:0 10px 26px rgba(255,107,53,.35); transition:transform .1s ease, filter .1s ease; }
  button:hover{ transform:translateY(-1px); }
  .btn-ghost{ background:rgba(255,255,255,.08); box-shadow:none; border:1px solid var(--line); }
  .btn-sec{ background:linear-gradient(135deg,var(--secondary),#6eddd6); color:#0f1422 }

  /* HEADER */
  .header{ grid-area:header; display:flex; align-items:center; justify-content:space-between; padding:14px 16px }
  .brand{ display:flex; align-items:center; gap:10px; font-weight:900; letter-spacing:.4px; font-size:clamp(20px,2.4vw,28px); background:linear-gradient(135deg, var(--primary), var(--accent)); -webkit-background-clip:text; -webkit-text-fill-color:transparent }
  .brand::before{ content:"ğŸ®"; font-size:1.2em }
  .actions{ display:flex; gap:10px; flex-wrap:wrap }

  /* PLAYERS */
  .players{ grid-area:players; padding:18px }
  .title{ color:var(--accent); font-weight:800; margin-block:2px 12px }
  .player{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:12px; border-radius:12px; background:rgba(255,255,255,.06); border:1px solid var(--line) }
  .player+.player{ margin-top:10px }
  .badge{ font-size:12px; font-weight:800; padding:6px 10px; border-radius:999px; }
  .b-wait{ background:linear-gradient(135deg,#f39c12,#e67e22) }
  .b-ready{ background:linear-gradient(135deg,#2ecc71,#27ae60) }
  .b-play{ background:linear-gradient(135deg,var(--blue),#5dade2) }

  /* MAIN */
  .main{ grid-area:main; display:flex; flex-direction:column; overflow:hidden }
  .main-top{ background:linear-gradient(135deg,var(--primary),var(--accent)); padding:14px 18px; border-start-start-radius:var(--r-lg); border-start-end-radius:var(--r-lg) }
  .round{ font-weight:900 }
  .main-body{ padding:28px 20px; display:grid; place-items:center; text-align:center; gap:14px; overflow:auto; min-block-size:0 }
  .topic{ font-weight:900; line-height:1.15; font-size:clamp(22px,2.8vw,34px); background:linear-gradient(135deg,var(--primary),var(--secondary),var(--accent)); -webkit-background-clip:text; -webkit-text-fill-color:transparent }
  .topic-sub{ color:var(--muted) }
  .hints{ display:flex; flex-wrap:wrap; gap:10px; justify-content:center }
  .hint{ background:linear-gradient(135deg,#b06ab3,#c39bd3); color:#fff; padding:8px 14px; border-radius:999px; font-weight:700 }

  /* CHAT + TIMER */
  .chat{ grid-area:chat; display:grid; grid-template-rows:auto auto minmax(0,1fr) auto; padding:16px; gap:12px }
  .timerBox{ display:grid; grid-template-columns:1fr auto; align-items:center; gap:8px }
  .time{ font-weight:900; font-size:clamp(24px,3vw,32px); color:var(--accent); text-shadow:0 0 14px var(--accent) }
  .tbar{ inline-size:100%; block-size:8px; background:rgba(255,255,255,.12); border-radius:999px; overflow:hidden }
  .tprog{ block-size:100%; inline-size:100%; background:linear-gradient(90deg,var(--accent),#f39c12) }
  .chatlog{ overflow:auto; padding:10px; border-radius:12px; border:1px dashed var(--line); background:rgba(0,0,0,.15); display:flex; flex-direction:column; gap:10px }
  .msg{ display:flex; gap:8px; align-items:flex-end }
  .msg.you{ justify-content:flex-end }
  .bubble{ max-inline-size:80%; padding:10px 12px; border-radius:14px; background:#26324a; border:1px solid var(--line) }
  .msg.you .bubble{ background:#2c3b59 }
  .from{ font-size:11px; color:var(--muted); margin-inline:4px }
  .chatInput{ display:flex; gap:10px }
  .chatInput input{ flex:1; padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:rgba(255,255,255,.08); color:#fff; font-weight:700 }

  /* BOARD */
  .board{ grid-area:board; padding:22px }
  .board h2{ color:var(--secondary); text-align:center; margin:0 0 14px; font-weight:900 }
  .drop{ min-block-size:180px; display:grid; grid-template-columns:repeat(auto-fit,minmax(84px,1fr)); gap:14px; align-items:start; justify-items:center; padding:18px; border-radius:14px; border:2px dashed var(--line); background:
    radial-gradient(circle at 30% 70%, rgba(78,205,196,.12) 0%, transparent 50%),
    repeating-linear-gradient(45deg, rgba(255,255,255,.02) 0px, rgba(255,255,255,.02) 10px, transparent 10px, transparent 20px);
    overflow:auto }
  .drop::before{ content:'ğŸ¯ ã‚«ãƒ¼ãƒ‰ã‚’ã“ã“ã«é…ç½®ã—ã¦ãã ã•ã„'; color:var(--muted); font-weight:700; opacity:.75 }
  .drop:not(:empty)::before{ display:none }
  .drop.drag{ border-color:var(--secondary); background:rgba(78,205,196,.08) }

  .card{ aspect-ratio:2/3; inline-size:84px; border-radius:12px; border:2px solid #3498db; background:linear-gradient(145deg,#2c3e50,#34495e); display:grid; place-items:center; position:relative; cursor:grab; box-shadow:0 12px 28px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.12); overflow:hidden }
  .card:hover{ transform:translateY(-6px) scale(1.03) }
  .card:active{ cursor:grabbing }
  .card::after{ content:""; position:absolute; inset:-50% auto auto -50%; inline-size:200%; block-size:200%; background:linear-gradient(45deg, transparent 30%, rgba(255,255,255,.12) 50%, transparent 70%); transform:rotate(45deg) }
  .card .num{ font-weight:900; font-size:1.8rem; text-shadow:0 2px 8px rgba(0,0,0,.5) }
  .card .order{ position:absolute; inset:-8px -8px auto auto; inline-size:28px; block-size:28px; border-radius:50%; border:3px solid #fff; display:grid; place-items:center; font-weight:900; font-size:14px; color:#0e1525; background:linear-gradient(135deg,var(--accent),#e67e22) }
  .card .who{ position:absolute; inset:auto 50% -6px 50%; transform:translateX(-50%); font-size:10px; font-weight:700; padding:4px 10px; border-radius:10px; color:#fff; border:1px solid var(--secondary); background:var(--bg2) }
  .card.hidden .num{ filter:blur(8px); opacity:.3 }
  .card.hidden::before{ content:'?'; position:absolute; inset:0; display:grid; place-items:center; font-weight:900; font-size:2rem; color:var(--secondary); text-shadow:0 0 16px var(--secondary) }

  /* HAND */
  .hand{ grid-area:hand; padding:18px; display:flex; gap:20px; align-items:center; justify-content:space-between; flex-wrap:wrap }
  .my{ display:flex; align-items:center; gap:14px }
  .label{ color:var(--accent); font-weight:900 }
  .mine{ aspect-ratio:2/3; inline-size:100px; border-radius:12px; border:3px solid #ffd700; background:linear-gradient(145deg,var(--primary),var(--accent)); display:grid; place-items:center; box-shadow:0 14px 34px rgba(255,107,53,.4), 0 0 40px rgba(255,230,109,.35); cursor:grab }
  .mine .num{ font-weight:900; font-size:2.1rem; color:#0e1525 }

  .word{ flex:1; display:flex; align-items:center; gap:10px; min-inline-size:min(420px,100%) }
  .word input{ flex:1; padding:12px 14px; border-radius:12px; border:2px solid var(--line); background:rgba(255,255,255,.08); color:#fff; font-weight:700 }
  .status{ font-size:12px; font-weight:800; padding:6px 10px; border-radius:999px }
  .wait{ background:linear-gradient(135deg,#f39c12,#e67e22) }
  .ready{ background:linear-gradient(135deg,#2ecc71,#27ae60) }

  /* RESPONSIVE */
  @media (max-width: 1100px){
    .app{ grid-template-areas:
      "header header"
      "main   chat"
      "players chat"
      "board  chat"
      "hand   chat";
      grid-template-columns: minmax(0,1fr) 22rem; }
  }
  @media (max-width: 800px){
    .app{ grid-template-areas:
      "header"
      "main"
      "chat"
      "players"
      "board"
      "hand";
      grid-template-columns: 1fr; }
    .hand{ flex-direction:column; align-items:stretch }
  }

  /* a11y reduce motion */
  @media (prefers-reduced-motion: reduce){ *{ transition-duration:.001ms !important; animation-duration:.001ms !important; animation-iteration-count:1 !important; scroll-behavior:auto !important } }
</style>
</head>
<body>
  <div class="app" role="application" aria-label="ITO party game">
    <!-- HEADER -->
    <header class="surface header">
      <div class="brand">ITO</div>
      <div class="actions">
        <button class="btn-ghost" id="dealBtn">ã‚«ãƒ¼ãƒ‰ã‚’é…ã‚‹</button>
        <button class="btn-ghost" id="revealBtn">å…¨éƒ¨ã‚ãã‚‹</button>
        <button class="btn-sec" id="resetBtn">ãƒªã‚»ãƒƒãƒˆ</button>
        <button id="readyBtn">æº–å‚™OK</button>
      </div>
    </header>

    <!-- PLAYERS -->
    <aside class="surface players">
      <div class="title">ğŸ‘¥ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ (3/3)</div>
      <div class="player"><span>ã‚ã</span><span class="badge b-wait" id="p1">æœªé…å¸ƒ</span></div>
      <div class="player"><span>chromeé€šå¸¸</span><span class="badge b-wait" id="p2">æœªé…å¸ƒ</span></div>
      <div class="player"><span>ã‚¨ãƒƒã‚¸ã§ã™ã€‚</span><span class="badge b-wait" id="p3">æœªé…å¸ƒ</span></div>

      <div class="title" style="margin:14px 0 10px">âš™ï¸ ã‚ªãƒ—ã‚·ãƒ§ãƒ³</div>
      <button class="btn-ghost" id="botBtn" style="inline-size:100%; margin-bottom:10px">é †ç•ªã«</button>
      <button class="btn-ghost" id="undoBtn" style="inline-size:100%">ã›ãƒ¼ã®ã§ï¼</button>
    </aside>

    <!-- MAIN -->
    <main class="surface main">
      <div class="main-top"><div class="round">ğŸ® ãƒ©ã‚¦ãƒ³ãƒ‰ 1 | ã‚«ãƒ†ã‚´ãƒª: é›‘è«‡ç³»</div></div>
      <div class="main-body">
        <h1 class="topic" id="topic">ãŠé¡Œï¼šã‚¢ãƒ‹ãƒ¡ãƒ»æ¼«ç”»ã®ã‚­ãƒ£ãƒ©ã®å¼·ã•</h1>
        <p class="topic-sub">ã€Œå¼±ã„ â†’ å¼·ã„ã€ã®é †ã§ã‚«ãƒ¼ãƒ‰ã‚’å ´ã«å‡ºãã†ï¼ˆå„è‡ª1æšï¼‰ã€‚</p>
        <div class="hints" id="hints"></div>
        <button class="btn-ghost" id="topicBtn" style="margin-top:8px">ãŠé¡Œå¤‰æ›´</button>
      </div>
    </main>

    <!-- CHAT + TIMER (ç›¸è«‡ã‚¹ãƒšãƒ¼ã‚¹) -->
    <aside class="surface chat">
      <div class="title">ğŸ’¬ ç›¸è«‡ã‚¹ãƒšãƒ¼ã‚¹</div>
      <div class="timerBox">
        <div class="time"><span id="timeLeft">40</span>s</div>
        <div style="display:flex; gap:8px">
          <button class="btn-ghost" id="startTimer">é–‹å§‹</button>
          <button class="btn-ghost" id="pauseTimer">ä¸€æ™‚åœæ­¢</button>
          <button class="btn-ghost" id="resetTimer">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
      </div>
      <div class="tbar"><div class="tprog" id="tprog"></div></div>
      <div class="chatlog" id="chatlog" aria-live="polite"></div>
      <div class="chatInput">
        <input id="chatInput" type="text" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ï¼ˆEnter ã§é€ä¿¡ï¼‰" maxlength="80" />
        <button class="btn-sec" id="sendBtn">é€ä¿¡</button>
      </div>
    </aside>

    <!-- BOARD -->
    <section class="surface board">
      <h2>ğŸ¯ ã‚«ãƒ¼ãƒ‰ãƒœãƒ¼ãƒ‰ï¼ˆå‡ºã—ãŸé †ï¼‰</h2>
      <div class="drop" id="board" aria-live="polite"></div>
      <p style="text-align:center; margin-top:12px; color:var(--muted); font-size:.9rem">ä¼ã›ãŸã¾ã¾ä¸¦ã¹ã¦ã€æœ€å¾Œã«ã‚ãã£ã¦çµæœåˆ¤å®š</p>
    </section>

    <!-- HAND -->
    <footer class="surface hand">
      <div class="my">
        <div class="label">ğŸƒ ã‚ãªãŸã®ã‚«ãƒ¼ãƒ‰</div>
        <div class="mine hidden" id="myCard" draggable="true" aria-grabbed="false"><div class="num" id="myNum">--</div></div>
        <div style="display:flex; flex-direction:column; gap:8px">
          <button id="playBtn">ã‚«ãƒ¼ãƒ‰ã‚’å‡ºã™</button>
          <button class="btn-ghost" id="takeBackBtn" disabled>å–ã‚Šæ¶ˆã—</button>
        </div>
      </div>
      <div class="word">
        <input id="wordInput" type="text" placeholder="ğŸ’­ é€£æƒ³ãƒ¯ãƒ¼ãƒ‰ï¼ˆä¾‹ï¼šãƒ”ã‚«ãƒãƒ¥ã‚¦ã€æ‚Ÿç©ºï¼‰" maxlength="20" />
        <button class="btn-sec" id="sendWord">é€ä¿¡</button>
        <span class="status wait" id="wordStatus">æœªå…¥åŠ›</span>
      </div>
    </footer>
  </div>

  <!-- Toast -->
  <div id="toast" aria-live="polite" style="position:fixed; inset: max(16px, var(--safe-top)) auto auto 50%; transform:translateX(-50%); padding:14px 18px; border-radius:12px; background:linear-gradient(135deg,var(--blue),#5dade2); color:#fff; font-weight:800; box-shadow:var(--shadow); opacity:0; pointer-events:none; transition:opacity .25s ease"></div>

<script>
  // ===== åŸºæœ¬çŠ¶æ…‹ =====
  const state = {
    players:[
      { id:1, name:'ã‚ã', number:null, word:'', played:false },
      { id:2, name:'chromeé€šå¸¸', number:null, word:'', played:false },
      { id:3, name:'ã‚¨ãƒƒã‚¸ã§ã™ã€‚', number:null, word:'', played:false },
    ],
    me:1,
    timer:40, total:40, timerId:null
  };

  // ===== å‚ç…§ =====
  const $ = (sel)=>document.querySelector(sel);
  const el = {
    myCard: $('#myCard'), myNum: $('#myNum'), board: $('#board'),
    hints: $('#hints'), wordInput: $('#wordInput'), wordStatus: $('#wordStatus'),
    chatlog: $('#chatlog'), chatInput: $('#chatInput'), tprog: $('#tprog'),
    timeLeft: $('#timeLeft'), toast: $('#toast'), topic: $('#topic'),
    pbadges:[null, $('#p1'), $('#p2'), $('#p3')]
  };

  // ===== Util =====
  const toast=(msg,type='info')=>{ el.toast.textContent = msg; el.toast.style.opacity=1; const map={success:'linear-gradient(135deg,#2ecc71,#27AE60)', error:'linear-gradient(135deg,#e74c3c,#c0392b)', info:'linear-gradient(135deg,#4a90e2,#5dade2)'}; el.toast.style.background = map[type]||map.info; clearTimeout(el.toast._t); el.toast._t=setTimeout(()=>el.toast.style.opacity=0,2200); };
  const setBadge=(id,text,cls)=>{ const b=el.pbadges[id]; if(!b) return; b.textContent=text; b.className='badge '+cls; };
  const rnd=(min,max)=>Math.floor(Math.random()*(max-min+1))+min;
  const uniqueNumbers=(min,max,count)=>{ const a=[...Array(max-min+1).keys()].map(i=>i+min); for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a.slice(0,count); };

  const cardEl=(p, hidden=true)=>{ const d=document.createElement('div'); d.className='card'+(hidden?' hidden':''); d.dataset.playerId=p.id; d.dataset.number=p.number; d.innerHTML=`<div class="num">${p.number}</div><div class="order"></div><div class="who">${p.name}</div>`; return d; };
  const refreshOrders=()=>{ [...el.board.querySelectorAll('.card')].forEach((c,i)=> c.querySelector('.order').textContent = i+1 ); };
  const refreshHints=()=>{ el.hints.innerHTML=''; state.players.forEach(p=>{ if(p.word.trim()){ const h=document.createElement('div'); h.className='hint'; h.textContent=`${p.name}: ${p.word}`; el.hints.appendChild(h); } }); };

  // ===== ã‚¿ã‚¤ãƒãƒ¼ï¼ˆãƒãƒ£ãƒƒãƒˆæ¬„å†…ï¼‰ =====
  const setTime=(n)=>{ state.timer=n; el.timeLeft.textContent=n; el.tprog.style.width=`${(n/state.total)*100}%`; };
  const startTimer=()=>{ clearInterval(state.timerId); state.timerId=setInterval(()=>{ setTime(Math.max(0,state.timer-1)); if(state.timer<=0){ clearInterval(state.timerId); sendSys('â±ï¸ ã‚¿ã‚¤ãƒ ã‚¢ãƒƒãƒ—ï¼', 'error'); } },1000); };
  const pauseTimer=()=>{ clearInterval(state.timerId); };
  const resetTimer=()=>{ pauseTimer(); setTime(state.total); };

  // ===== ãƒãƒ£ãƒƒãƒˆ =====
  const pushMsg=(from,text,me=false)=>{ const line=document.createElement('div'); line.className='msg'+(me?' you':''); line.innerHTML=`${!me?`<span class="from">${from}</span>`:''}<div class="bubble">${text.replace(/[&<>]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c]))}</div>`; el.chatlog.appendChild(line); el.chatlog.scrollTop=el.chatlog.scrollHeight; };
  const sendMe=()=>{ const v=el.chatInput.value.trim(); if(!v) return; pushMsg('ã‚ãªãŸ', v, true); el.chatInput.value=''; };
  const sendSys=(text,type='info')=>{ pushMsg('SYSTEM', text); toast(text, type); };

  // ===== ã‚²ãƒ¼ãƒ æŒ™å‹• =====
  const deal=()=>{
    const nums=uniqueNumbers(1,100,state.players.length);
    state.players.forEach((p,i)=>{ p.number=nums[i]; p.word=''; p.played=false; setBadge(p.id,'é…å¸ƒæ¸ˆã¿','b-ready'); });
    const me=state.players.find(p=>p.id===state.me); el.myNum.textContent=me.number; el.myCard.classList.remove('hidden');
    el.board.innerHTML=''; refreshHints(); el.wordInput.value=''; el.wordStatus.textContent='æœªå…¥åŠ›'; el.wordStatus.className='status wait'; $('#takeBackBtn').disabled=true; sendSys('ğŸ´ ã‚«ãƒ¼ãƒ‰é…å¸ƒã—ã¾ã—ãŸ','success'); resetTimer(); };

  const play=(p)=>{ if(!p.number||p.played) return; p.played=true; el.board.appendChild(cardEl(p,true)); refreshOrders(); setBadge(p.id,'å‡ºã—ãŸ','b-play'); if(p.id===state.me){ $('#takeBackBtn').disabled=false; toast('âœ¨ ã‚«ãƒ¼ãƒ‰ã‚’å‡ºã—ã¾ã—ãŸï¼','success'); } };
  const takeBack=()=>{ const cards=el.board.querySelectorAll('.card'); const last=cards[cards.length-1]; if(!last) return; const pid=Number(last.dataset.playerId); if(pid!==state.me) return; const p=state.players.find(x=>x.id===pid); p.played=false; last.remove(); refreshOrders(); setBadge(pid,'é…å¸ƒæ¸ˆã¿','b-ready'); $('#takeBackBtn').disabled=true; toast('â†©ï¸ å–ã‚Šæ¶ˆã—','info'); };

  const reveal=()=>{ const cards=[...el.board.querySelectorAll('.card')]; if(!cards.length){ toast('âŒ ã¾ã ã‚«ãƒ¼ãƒ‰ãŒå‡ºã•ã‚Œã¦ã„ã¾ã›ã‚“','error'); return; } cards.forEach(c=>c.classList.remove('hidden')); const nums=cards.map(c=>Number(c.dataset.number)); const ok=nums.every((n,i)=> i===0 || nums[i-1] < n); setTimeout(()=>{ if(ok){ sendSys('ğŸ‰ æˆåŠŸï¼ï¼ å®Œç’§ãªé †åºã§ã™ï¼','success'); state.players.forEach(p=>{ if(p.played) setBadge(p.id,'æˆåŠŸ','b-ready'); }); } else { sendSys('ğŸ’¥ å¤±æ•—... é †åºãŒé•ã„ã¾ã™','error'); state.players.forEach(p=>{ if(p.played) setBadge(p.id,'å¤±æ•—','b-wait'); }); } },400); };

  const botAuto=()=>{
    if(state._bot){ clearInterval(state._bot); state._bot=null; sendSys('ğŸ¤– BOTåœæ­¢','info'); return; }
    const others=state.players.filter(p=>p.id!==state.me);
    const tick=()=>{ const alive=others.filter(p=>!p.played && p.number); if(!alive.length){ clearInterval(state._bot); state._bot=null; return; } const p=alive[Math.floor(Math.random()*alive.length)]; if(!p.word){ const s=['å¼·æ•µ','ä¸­ç´š','åˆç´š','æœ€å¼·','æ™®é€š']; p.word=s[rnd(0,s.length-1)]; refreshHints(); } play(p); };
    state._bot=setInterval(tick,1800); sendSys('ğŸ¤– BOTè‡ªå‹•ãƒ—ãƒ¬ã‚¤é–‹å§‹','info'); };

  const sendWord=()=>{ const w=el.wordInput.value.trim(); if(!w){ toast('â— ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„','error'); return; } const me=state.players.find(p=>p.id===state.me); me.word=w; el.wordStatus.textContent=w; el.wordStatus.className='status ready'; refreshHints(); toast('ğŸ’­ ãƒ¯ãƒ¼ãƒ‰ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼','success'); };

  // ===== ãƒ‰ãƒ©ãƒƒã‚° & ãƒ‰ãƒ­ãƒƒãƒ— =====
  el.myCard.addEventListener('dragstart',e=>{ e.dataTransfer.setData('text/plain', String(state.me)); el.myCard.style.opacity='.6'; });
  el.myCard.addEventListener('dragend',()=>{ el.myCard.style.opacity='1'; });
  el.board.addEventListener('dragover',e=>{ e.preventDefault(); el.board.classList.add('drag'); });
  el.board.addEventListener('dragleave',()=>{ el.board.classList.remove('drag'); });
  el.board.addEventListener('drop',e=>{ e.preventDefault(); el.board.classList.remove('drag'); const me=state.players.find(p=>p.id===state.me); if(me && !me.played) play(me); });

  // ===== ã‚¤ãƒ™ãƒ³ãƒˆé…ç·š =====
  $('#dealBtn').addEventListener('click', deal);
  $('#playBtn').addEventListener('click', ()=> play(state.players.find(p=>p.id===state.me)) );
  $('#takeBackBtn').addEventListener('click', takeBack);
  $('#revealBtn').addEventListener('click', reveal);
  $('#botBtn').addEventListener('click', botAuto);
  $('#sendWord').addEventListener('click', sendWord);
  $('#wordInput').addEventListener('keydown',e=>{ if(e.key==='Enter') sendWord(); });

  // chat
  $('#sendBtn').addEventListener('click', sendMe);
  $('#chatInput').addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); sendMe(); }});

  // timer controls
  $('#startTimer').addEventListener('click', startTimer);
  $('#pauseTimer').addEventListener('click', pauseTimer);
  $('#resetTimer').addEventListener('click', resetTimer);

  // topic
  const topics=[
    `ãŠé¡Œï¼šã‚¢ãƒ‹ãƒ¡ãƒ»æ¼«ç”»ã®ã‚­ãƒ£ãƒ©ã®å¼·ã•`,
    `ãŠé¡Œï¼šã‚¢ã‚¤ã‚¹ã®ã€Œã•ã£ã±ã‚Šåº¦ã€`,
    `ãŠé¡Œï¼šãƒ›ãƒ©ãƒ¼æ˜ ç”»ã®ã€Œæ€–ã•ã€`,
    `ãŠé¡Œï¼šå‹•ç‰©ã®ã€Œä¿Šæ•ã•ã€`,
    `ãŠé¡Œï¼šæ–™ç†ã®ã€Œè¾›ã•ã€`,
    `ãŠé¡Œï¼šä¹—ã‚Šç‰©ã®ã€Œé€Ÿã•ã€`,
    `ãŠé¡Œï¼šæ¥½å™¨ã®ã€ŒéŸ³ã®é«˜ã•ã€`,
    `ãŠé¡Œï¼šå»ºç‰©ã®ã€Œé«˜ã•ã€`,
  ];
  $('#topicBtn').addEventListener('click',()=>{ let next; do{ next=topics[rnd(0,topics.length-1)]; }while(next===el.topic.textContent); el.topic.textContent=next; toast('ğŸ¯ ãŠé¡Œã‚’å¤‰æ›´ã—ã¾ã—ãŸ','info'); });

  // åˆæœŸåŒ–
  setTime(state.total);
  pushMsg('SYSTEM','ã“ã“ã¯ç›¸è«‡ã®ãŸã‚ã®ãƒãƒ£ãƒƒãƒˆæ¬„ã§ã™ã€‚ã‚¿ã‚¤ãƒãƒ¼ã‚’é–‹å§‹ã—ã¦è©±ã—åˆãŠã†ï¼');
  toast('ğŸ® ITOã¸ã‚ˆã†ã“ãï¼', 'success');
</script>
</body>
</html>
